<!DOCTYPE html>
<html lang="en-US">
  <head>
    

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <link rel="stylesheet" href="/blog/assets/css/main.css">
    <script src="https://kit.fontawesome.com/f9271f6bdd.js" crossorigin="anonymous"></script>
    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark-dimmed.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
  </head>

  <body class="font-mono list-disc bg-gray-700">
    <div class="pt-8 bg-gray-700">
      
        <nav class="flex flex-wrap items-center justify-center px-2 py-4 mb-6">
  <div class="titleImagePosition">
    <a href="/blog/" class="!px-0 !py-0">
      <img class="titleImage" src="/blog/assets/img/title.jpeg" alt="author profile image">
    </a>
  </div>
</nav>

      
      
  
    <div id='sidebar' class='fixed py-16 hidden lg:block'></div>
    <div id='burger-sidebar' class='pt-24 pl-4 fixed hidden md:block'></div>
  

  <div class='prose bg-gray-400' id='article'>
    <div id='word-count' class='pt-4 pl-8 fixed'>words: 80</div>
    <div class='text-center'>
      
    </div>
    <div class='md:px-4 md:grid lg:px-72'>
      <h1 class='text-center mt-6 mb-6'>Active Record</h1>
      <h2 id="introduction">Introduction</h2>

<ul>
  <li>Software design pattern</li>
  <li>Used in object-oriented programming to manage database access</li>
  <li>A part of the Model-View-Controller (MVC) architectural pattern</li>
  <li>Provides an easy and intuitive way to represent and manipulate data stored in a database</li>
  <li>Define classes that map to database tables, and provides a set of methods that can be used to query, insert, update, and delete records from the database
    <ul>
      <li>Table map to classes</li>
      <li>Rows map to objects</li>
      <li>Columns map to object attributes</li>
    </ul>
  </li>
  <li>Abstracts away much of the low-level database interaction code that developers would otherwise have to write. This makes it easier to work with databases, and also reduces the likelihood of errors and bugs</li>
  <li>Used in popular web frameworks such as Ruby on Rails, Django, and Laravel. It is a powerful tool that allows developers to focus on building their applications, rather than on database management</li>
</ul>

<h2 id="why">Why</h2>

<p>Active Record is a specific implementation of <a href="/blog/rails/2022/01/13/object-relational-mapping.html">ORM</a> that maps database tables to objects. It allows developers to work with database records as if they were objects, with each record represented by a single instance of a class. Active Record handles the persistence of the objects to the database and provides methods for querying and updating the data.</p>

<h2 id="how">How</h2>

<p>Research Active Record in Rails. Rails use adapter design pattern for user to use same syntax for different SQL.</p>

<h3 id="design-pattern">design pattern</h3>

<p>Please understand <a href="/blog/design-pattern/2023/03/30/adapter.html">adapter</a> first.</p>

<h3 id="model">Model</h3>

<ul>
  <li>In Active Record, a model represents a table in a database. It encapsulates the logic for retrieving, creating, updating, and deleting records in the table.</li>
  <li>Attributes are the properties of a model that map to the columns of the corresponding database table. They represent the data stored in the table.</li>
  <li>Associations: Associations represent the relationships between models in the database. They define how records in one table are related to records in another table, such as a one-to-one, one-to-many, or many-to-many relationship.</li>
  <li>In Ruby on Rails, a model is a component of the MVC (Model-View-Controller) architecture that is used to represent the data and business logic of an application. In this context, a model can be any object that is used to interact with data, not just an Active Record model. For example, a model could represent an API endpoint, a user session, or a business process. In Active Record, a model is specifically an object that represents a table in a database, while in Ruby on Rails, a model is a more general term that refers to any object that represents data and business logic in an application.</li>
</ul>

<p>On the application point of view, we only care about how to use model. In rails, all model inherit from <code class="language-plaintext highlighter-rouge">ActiveRecord::Base</code>; for example,</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</code></pre></div></div>

<p>So please refer to <a href="/blog/rails/2021/03/02/model.html">model</a> for more information</p>

<h3 id="methods">methods</h3>

<p>find is a method provided by the ActiveRecord module in Ruby on Rails that retrieves a single record from the database based on its primary key. For example, if you have a model called User and you want to retrieve the user with an ID of 1, you can call User.find(1) and Rails will retrieve the corresponding record from the users table in the database. If the record is not found, find will raise an ActiveRecord::RecordNotFound exception.</p>

<p>find_by is similar to find, but it retrieves a single record based on a specific attribute value, rather than the primary key. For example, if you want to retrieve the user with an email address of “johndoe@example.com”, you can call User.find_by(email: ‘johndoe@example.com’) and Rails will retrieve the corresponding record from the users table. If the record is not found, find_by will return nil.</p>

<p>The main difference is that find(1) will raise an ActiveRecord::RecordNotFound exception if the record is not found, while find_by(id: 1) will simply return nil. This means that if you are certain that the record with a primary key of 1 exists in the database, you can use find(1) to retrieve it and raise an exception if it is not found. On the other hand, if you are not sure if the record exists, or if you don’t want your application to crash if the record is not found, you can use find_by(id: 1) to retrieve it and handle the nil return value accordingly.</p>

<p>where: The where method is used to retrieve a collection of records that match a set of conditions. For example, User.where(active: true) would retrieve all users that have the active attribute set to true.</p>

<p>order: The order method is used to specify the order in which records are retrieved. For example, User.order(:name) would retrieve all users ordered by their name attribute in ascending order.</p>

<p>limit and offset: The limit and offset methods are used to retrieve a subset of records from the database. For example, User.limit(10).offset(5) would retrieve 10 users starting from the 6th user.</p>

<p>select: The select method is used to retrieve only specific columns from the database. For example, User.select(:name, :email) would retrieve only the name and email columns for all users.</p>

<p>joins: The joins method is used to retrieve records from multiple tables based on a relationship. For example, User.joins(:posts) would retrieve all users who have at least one post.</p>

<p>includes: The includes method is used to retrieve records from multiple tables while preloading associated records to avoid N+1 queries. For example, User.includes(:posts) would retrieve all users and their associated posts in a single query.</p>

<p>These are just a few examples of the methods provided by the ActiveRecord module in Rails for querying the database.</p>

<h3 id="validation">Validation</h3>

<p>Validations: Validations are rules that ensure the data stored in a model is valid and consistent with the requirements of the application. They can be used to enforce constraints such as required fields, data format, and uniqueness.</p>

<p>For data to be consistent in a model, we should validate it <strong>before</strong> inserting into a database. The methods for validation in <a href="https://guides.rubyonrails.org/active_record_validations.html">Active Record Validation - Ruby on Rails</a></p>

<h3 id="callbacks">Callbacks</h3>

<p>Callbacks: Callbacks are methods that are automatically called at certain points in the lifecycle of a model, such as before or after a record is saved or deleted. They can be used to perform additional operations or validations on the data.</p>

<p>Callback is the function that are going to be call after a function executed.</p>

<p>The life cycle of an object in a framework always plays key role. The process:
<img src="/assets/img/active_record_callbacks.png" alt="" />(reference: <a href="https://railsbook.tw/"><strong>railsbook.pdf</strong></a>)</p>

<p>The above cycle only shows the hooks of save. For more information, please refer to <a href="https://guides.rubyonrails.org/active_record_callbacks.html">active record callbacks</a></p>

<h4 id="some-interesting-queries-i-cannot-understand-it-right-now">Some interesting queries: (I cannot understand it right now)</h4>

<p><strong>Iteration</strong>: If we want to send an email to all users</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Customer.all.each do |customer|
  NewsMailer.weekly(customer).deliver_now
end
</code></pre></div></div>
<p>However, the <code class="language-plaintext highlighter-rouge">.all</code> takes too much memory; as a result, we can use <code class="language-plaintext highlighter-rouge">find_each</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Customer.find_each(batch_size: 5000) do |customer|
  NewsMailer.weekly(customer).deliver_now
end
</code></pre></div></div>
<p>to portion the table and read it in a batch size many times.</p>

<p>The source code of <code class="language-plaintext highlighter-rouge">find_each</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def find_each(start: nil, finish: nil, batch_size: 1000, error_on_ignore: nil, order: :asc)
  if block_given?
    find_in_batches(start: start, finish: finish, batch_size: batch_size, error_on_ignore: error_on_ignore, order: order) do |records|
      records.each { |record| yield record }
    end
  else
    enum_for(:find_each, start: start, finish: finish, batch_size: batch_size, error_on_ignore: error_on_ignore, order: order) do
      relation = self
      apply_limits(relation, start, finish, order).size
    end
  end
end
</code></pre></div></div>
<p>The source code of <code class="language-plaintext highlighter-rouge">find_in_batches</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def find_in_batches(start: nil, finish: nil, batch_size: 1000, error_on_ignore: nil, order: :asc)
  relation = self
  unless block_given?
    return to_enum(:find_in_batches, start: start, finish: finish, batch_size: batch_size, error_on_ignore: error_on_ignore, order: order) do
      total = apply_limits(relation, start, finish, order).size
      (total - 1).div(batch_size) + 1
    end
  end

  in_batches(of: batch_size, start: start, finish: finish, load: true, error_on_ignore: error_on_ignore, order: order) do |batch|
    yield batch.to_a
  end
end
</code></pre></div></div>
<p>The source code of <code class="language-plaintext highlighter-rouge">in_batches</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def in_batches(of: 1000, start: nil, finish: nil, load: false, error_on_ignore: nil, order: :asc)
  relation = self
  unless block_given?
    return BatchEnumerator.new(of: of, start: start, finish: finish, relation: self)
  end

  unless [:asc, :desc].include?(order)
    raise ArgumentError, ":order must be :asc or :desc, got #{order.inspect}"
  end

  if arel.orders.present?
    act_on_ignored_order(error_on_ignore)
  end

  batch_limit = of
  if limit_value
    remaining   = limit_value
    batch_limit = remaining if remaining &lt; batch_limit
  end

  relation = relation.reorder(batch_order(order)).limit(batch_limit)
  relation = apply_limits(relation, start, finish, order)
  relation.skip_query_cache! # Retaining the results in the query cache would undermine the poinof batching
  batch_relation = relation

  loop do
    if load
      records = batch_relation.records
      ids = records.map(&amp;:id)
      yielded_relation = where(primary_key =&gt; ids)
      yielded_relation.load_records(records)
    else
      ids = batch_relation.pluck(primary_key)
      yielded_relation = where(primary_key =&gt; ids)
    end

    break if ids.empty?

    primary_key_offset = ids.last
    raise ArgumentError.new("Primary key not included in the custom select clause") unlesprimary_key_offset

    yield yielded_relation

    break if ids.length &lt; batch_limit

    if limit_value
      remaining -= ids.length

      if remaining == 0
        # Saves a useless iteration when the limit is a multiple of the
        # batch size.
        break
      elsif remaining &lt; batch_limit
        relation = relation.limit(remaining)
      end
    end

    batch_relation = relation.where(
      predicate_builder[primary_key, primary_key_offset, order == :desc ? :lt : :gt]
    )
  end
end
</code></pre></div></div>

<h3 id="association">Association</h3>
<p>For more detail, please refer to <a href="https://guides.rubyonrails.org/association_basics.html"><strong>Active Record - Association</strong></a>. Some interesting association: polymorphic, STI, polymorphic + STI</p>

<h4 id="polymorphic">polymorphic</h4>
<p>We should use <code class="language-plaintext highlighter-rouge">polymorphic</code>, if a model belongs to more than one model and the meaning of the <code class="language-plaintext highlighter-rouge">belongs_to</code> are almost the same. However, if the <code class="language-plaintext highlighter-rouge">belongs_to</code> has significantly different meanings, then we should use multiple <code class="language-plaintext highlighter-rouge">has_many</code> and <code class="language-plaintext highlighter-rouge">belongs_to</code> rather than <code class="language-plaintext highlighter-rouge">polymorphic</code>. For example, both product and user can be commented, so we can create <code class="language-plaintext highlighter-rouge">Comment</code> model with</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rails g model Comment commentable_type:string commentable_id:integer body:text
</code></pre></div></div>
<p>and the model setting would be as follow:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Comment &lt; ApplicationRecord
  belongs_to :commentable, polymorphic: true
end

class Product &lt; ApplicationRecord
  has_many :comments, as: :commentable
end

class User &lt; ApplicationRecord
  has_many :comments, as: :commentable
end
</code></pre></div></div>
<p>As the setting above, the <code class="language-plaintext highlighter-rouge">commentable_id</code> will save the id of <code class="language-plaintext highlighter-rouge">product</code> and <code class="language-plaintext highlighter-rouge">user</code> and because of the <code class="language-plaintext highlighter-rouge">commentable_type</code>, no worries if the id of <code class="language-plaintext highlighter-rouge">product</code> and <code class="language-plaintext highlighter-rouge">user</code> are the same.</p>

<p>Note that the structure can be written as follow:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Comment &lt; ApplicationRecord
  belongs_to :product
  belongs_to :user
end

class Product &lt; ApplicationRecord
  has_many :comments
end

class User &lt; ApplicationRecord
  has_many :comments
end
</code></pre></div></div>

<h4 id="sti-single-table-inheritance">STI (single table inheritance)</h4>
<p>When to use <code class="language-plaintext highlighter-rouge">single table inheritance</code>? (skip)</p>

<h4 id="polymorphic--sti">Polymorphic + STI</h4>
<p>For example, if we want to setup a platform and users can be both employer and employee for a task and each task can only have one employer and employee.</p>

<p>Then, the model setups would be</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Task &lt; ActiveRecord::Base
  belongs_to :liable, polymorphic: true

  def liable_type=(class_name)
    super(class_name.constantize.base_class.to_s)
  end
end

class User &lt; Active::Base
  has_many :task, as: :liable, dependent: :destroy
end

class Employer &lt; User
  has_and_belongs_to_many :employess
end

class Employee &lt; User
  has_and_belongs_to_many :employers
end
</code></pre></div></div>
<p>Notice! Employer and Employee use the concept of STI(Single-table inheritance).</p>

<p>Try to understand how to query in rails with <a href="https://guides.rubyonrails.org/active_record_querying.html">ActiveRecord Query Interface</a></p>

<h2 id="what">what</h2>

<h3 id="source-code-of-adapter-in-rails-active-record">Source Code of adapter in rails active record</h3>

<p>Please <code class="language-plaintext highlighter-rouge">rails new</code> a project and create a random table (I create table with <code class="language-plaintext highlighter-rouge">rails g scaffold User name:string email:string</code> and then <code class="language-plaintext highlighter-rouge">rails db:migrate</code>) and then we can create a new User with <code class="language-plaintext highlighter-rouge">test = User.create</code>. To track the source code, <code class="language-plaintext highlighter-rouge">bundle open activerecord</code> and it will open the gem in <code class="language-plaintext highlighter-rouge">.rvm/gems/ruby-2.7.4/gems/activerecord-6.1.4.4/lib</code>. I will only track the <code class="language-plaintext highlighter-rouge">create</code> method because I only want to know the design. We can track it with <code class="language-plaintext highlighter-rouge">binding.pry</code>. Try to find the raw SQL code. After you have done, input <code class="language-plaintext highlighter-rouge">bundle pristine activerecord</code> to recover the gems.</p>

<p>Input <code class="language-plaintext highlighter-rouge">ActiveRecord::Base.connection.adapter_name</code> in console, to know what database system using</p>

<p><code class="language-plaintext highlighter-rouge">User.create</code> link to general methods of ActiveRecord of create: Fire up the rails console, and input <code class="language-plaintext highlighter-rouge">User.create</code>, then the SQL would be</p>

<pre><code class="language-SQL">TRANSACTION (0.1ms)  begin transaction
User Create (0.4ms)  INSERT INTO "users" ("created_at", "updated_at") VALUES (?, ?)  [["created_at", "2022-01-11 02:01:31.475084"], ["updated_at", "2022-01-11 02:01:31.475084"]]
TRANSACTION (1.0ms)  commit transaction
</code></pre>

<p>I am using SQLite and the key issue is why rails knows to use the INSERT grammar for SQLite instead of MySQL or PG.</p>

<p>Add <code class="language-plaintext highlighter-rouge">binding.pry</code> in class as follow:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
<span class="k">end</span>
</code></pre></div></div>

<p>and input <code class="language-plaintext highlighter-rouge">User.create</code> in rails console again. Then the data flow of <code class="language-plaintext highlighter-rouge">create</code> would be as follow:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">create</code> method in superclass when calling <code class="language-plaintext highlighter-rouge">user.create</code> in <code class="language-plaintext highlighter-rouge">.../research_activerecord/app/models/user.rb</code></li>
  <li>the superclass of <code class="language-plaintext highlighter-rouge">User</code> is <code class="language-plaintext highlighter-rouge">ApplicationRecord</code></li>
  <li>the superclass of <code class="language-plaintext highlighter-rouge">ApplicationRecord</code> is <code class="language-plaintext highlighter-rouge">ActiveRecord::Base</code></li>
  <li>Have a look at <code class="language-plaintext highlighter-rouge">base.rb</code></li>
</ol>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">ActiveRecord</span> <span class="c1">#:nodoc:</span>
  <span class="o">...</span>
  <span class="k">class</span> <span class="nc">Base</span>
    <span class="o">...</span>
    <span class="kp">extend</span> <span class="no">ConnectionHandling</span>
    <span class="o">...</span>
    <span class="kp">include</span> <span class="no">Core</span>
    <span class="kp">include</span> <span class="no">Persistence</span>
    <span class="o">...</span>
  <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Given that we know, <code class="language-plaintext highlighter-rouge">create</code> methods equals to <code class="language-plaintext highlighter-rouge">new</code> + <code class="language-plaintext highlighter-rouge">save</code>, then in <code class="language-plaintext highlighter-rouge">Core</code>, there are methods such as <code class="language-plaintext highlighter-rouge">initialize</code> and in <code class="language-plaintext highlighter-rouge">Persistence</code>, there are methods such as <code class="language-plaintext highlighter-rouge">save</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">create</code> method in <code class="language-plaintext highlighter-rouge">persistence.rb</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">attributes</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
    <span class="n">attributes</span><span class="p">.</span><span class="nf">collect</span> <span class="p">{</span> <span class="o">|</span><span class="kp">attr</span><span class="o">|</span> <span class="n">create</span><span class="p">(</span><span class="kp">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">else</span>
    <span class="n">object</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">object</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">object</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>As you can see, it will call <code class="language-plaintext highlighter-rouge">new</code> and then <code class="language-plaintext highlighter-rouge">save</code> method. We can</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">new</code> (to eb continued)</li>
  <li><code class="language-plaintext highlighter-rouge">save</code> in <code class="language-plaintext highlighter-rouge">persistence.rb</code> -&gt; <code class="language-plaintext highlighter-rouge">create_or_update</code> -&gt; <code class="language-plaintext highlighter-rouge">result = new_record? ? _create_record(&amp;block) : _update_record(&amp;block)</code> -&gt; <code class="language-plaintext highlighter-rouge">_create_record(&amp;block)</code> -&gt; <code class="language-plaintext highlighter-rouge">yield(self)</code></li>
</ul>

<p>It is tedious to probe the methods. The general ideas are these methods will link to <code class="language-plaintext highlighter-rouge">build_insert_sql</code> of <code class="language-plaintext highlighter-rouge">connection</code> as follow:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">insert_all</code> in <code class="language-plaintext highlighter-rouge">.../lib/active_record/persistence.rb</code> -&gt; <code class="language-plaintext highlighter-rouge">InsertAll.new(self, attributes, on_duplicate: :skip, returning: returning, unique_by: unique_by).execute</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">initialize(model, inserts, on_duplicate:, returning: nil, unique_by: nil)</code> in <code class="language-plaintext highlighter-rouge">.../lib/active_record/insert_all.rb</code> and the model is <code class="language-plaintext highlighter-rouge">User</code> in my case</li>
      <li><code class="language-plaintext highlighter-rouge">execute</code> in <code class="language-plaintext highlighter-rouge">.../lib/active_record/insert_all.rb</code></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">execute</code> -&gt; <code class="language-plaintext highlighter-rouge">connection.exec_insert_all to_sql, message</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">connection</code> in <code class="language-plaintext highlighter-rouge">attr_reader :connection</code>, which means
        <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">def</span> <span class="nf">connection</span>
   <span class="vi">@connection</span>
 <span class="k">end</span>
</code></pre></div>        </div>
      </li>
      <li><code class="language-plaintext highlighter-rouge">@connection = model.connection</code> and <code class="language-plaintext highlighter-rouge">model</code> is the <code class="language-plaintext highlighter-rouge">self</code> in <code class="language-plaintext highlighter-rouge">InsertAll.new</code>, which is <code class="language-plaintext highlighter-rouge">User</code> in my case.</li>
      <li><code class="language-plaintext highlighter-rouge">exec_insert_all</code> in <code class="language-plaintext highlighter-rouge">database_statements.rb</code></li>
      <li><code class="language-plaintext highlighter-rouge">to_sql</code> = <code class="language-plaintext highlighter-rouge">connection.build_insert_sql(ActiveRecord::InsertAll::Builder.new(self))</code> (where connection transfer code into SQL)</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">build_insert_sql</code> can be in <code class="language-plaintext highlighter-rouge">abstract_adapter.rb</code>, <code class="language-plaintext highlighter-rouge">abstract_mysql_adapter.rb</code>, <code class="language-plaintext highlighter-rouge">postgresql_adapter.rb</code>, or <code class="language-plaintext highlighter-rouge">sqlite3_adapter.rb</code></li>
  <li>rails determines which <code class="language-plaintext highlighter-rouge">build_insert_sql</code> to be used by <code class="language-plaintext highlighter-rouge">connection</code></li>
</ul>

<p>The most important part is <code class="language-plaintext highlighter-rouge">to_sql</code>. Then now the problem is how rails determines with adapter to be used:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">establish_connection</code> in <code class="language-plaintext highlighter-rouge">.../lib/active_record/connection_handling.rb</code></li>
  <li>it determines which adapter to be used through <code class="language-plaintext highlighter-rouge">establish_connection</code></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">establish_connection</span><span class="p">(</span>
  <span class="ss">adapter:  </span><span class="s2">"mysql2"</span><span class="p">,</span>
  <span class="ss">host:     </span><span class="s2">"localhost"</span><span class="p">,</span>
  <span class="ss">username: </span><span class="s2">"myuser"</span><span class="p">,</span>
  <span class="ss">password: </span><span class="s2">"mypass"</span><span class="p">,</span>
  <span class="ss">database: </span><span class="s2">"somedatabase"</span>
<span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>and it will call <code class="language-plaintext highlighter-rouge">connection_handler</code>, which is <code class="language-plaintext highlighter-rouge">self.connection_handler</code> in <code class="language-plaintext highlighter-rouge">core.rb</code></li>
  <li>call <code class="language-plaintext highlighter-rouge">default_connection_handler</code> given there is no thread -&gt; <code class="language-plaintext highlighter-rouge">self.default_connection_handler = ConnectionAdapters::ConnectionHandler.new</code></li>
  <li><code class="language-plaintext highlighter-rouge">initialize</code> in <code class="language-plaintext highlighter-rouge">class ConnectionHandler</code> of <code class="language-plaintext highlighter-rouge">connection_pool.rb</code></li>
  <li>so it actually call <code class="language-plaintext highlighter-rouge">establish_connection</code> in <code class="language-plaintext highlighter-rouge">connection_pool.rb</code> -&gt; <code class="language-plaintext highlighter-rouge">resolve_pool_config</code> -&gt; <code class="language-plaintext highlighter-rouge">path_to_adapter = "active_record/connection_adapters/#{db_config.adapter}_adapter"</code> -&gt; <code class="language-plaintext highlighter-rouge">require path_to_adapter</code> (<strong>where the determination of adapter</strong>)</li>
  <li>Take mysql as example, it require <code class="language-plaintext highlighter-rouge">.../lib/active_record/connection_adapters/mysql2_adapter.rb</code> -&gt; <code class="language-plaintext highlighter-rouge">require "active_record/connection_adapters/abstract_mysql_adapter"</code></li>
  <li><code class="language-plaintext highlighter-rouge">build_insert_sql</code> in <code class="language-plaintext highlighter-rouge">.../lib/active_record/connection_adapters/abstract_mysql_adapter</code></li>
</ul>

<h2 id="reference">Reference</h2>

<p><a href="https://zh.wikipedia.org/wiki/Active_Record"><strong>Active Record - 维基百科，自由的百科全书</strong></a></p>

<p><a href="https://guides.rubyonrails.org/active_record_basics.html"><strong>Active Record - Ruby on Rails</strong></a></p>

<p><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#label-Polymorphic+Associations"><strong>polymorphic + STI</strong></a></p>

<p><a href="https://eng.localytics.com/odbc-and-writing-your-own-activerecord-adapter/">ODBC and writing your own ActiveRecord adapter</a></p>

<p>(http://www.monkeyandcrow.com/blog/reading_rails_the_adapter_pattern/)</p>

    </div>
  </div>

  <footer class="relative px-4 pt-4 pb-4">
    <!-- footer msg -->
  <div class="flex flex-wrap items-center justify-center">
    <br>
  </div>
</footer>


      <button
        type="button"
        data-mdb-ripple="true"
        data-mdb-ripple-color="light"
        class="scrollTopBtn"
        id="btn-back-to-top"
      >
        <svg aria-hidden="true" focusable="false" data-prefix="fas" class="w-4 h-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"></path></svg>
      </button>
    </div>
  </body>

  <script>
    /* Function for getting the current year in the footer */
    (function () {
      if (document.getElementById("get-current-year")) {
        document.getElementById(
          "get-current-year"
        ).innerHTML = new Date().getFullYear();
      }
    })();
    /* Function for opening navbar on mobile */
    function toggleNavbar(collapseID) {
        document.getElementById(collapseID).classList.toggle("hidden");
        document.getElementById(collapseID).classList.toggle("block");
      }
    /* Function for dropdowns */
    function openDropdown(event, dropdownID) {
      let element = event.target;
      while (element.nodeName !== "A") {
        element = element.parentNode;
      }
      document.getElementById(dropdownID).classList.toggle("hidden");
      document.getElementById(dropdownID).classList.toggle("block");
    }

    // Get the button
    let myButton = document.getElementById("btn-back-to-top");
    // When the user scrolls down 20px from the top of the document, show the button
    window.onscroll = function () {
      scrollFunction();
    };
    function scrollFunction() {
      if (
        document.body.scrollTop > 20 ||
        document.documentElement.scrollTop > 20
      ) {
        myButton.style.display = "block";
      } else {
        myButton.style.display = "none";
      }
    }
    // When the user clicks on the button, scroll to the top of the document
    myButton.addEventListener("click", backToTop);
    function backToTop() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }
  </script>

  <script type="text/javascript" src="/blog/assets/javascript/bundle.js" charset="utf-8"></script>
</html>
