<!DOCTYPE html>
<html lang="en-US">
  <head>
    <!-- 3D drawing -->
    
    <!-- 2D drawing -->
    
    <!-- for mathjax support -->
    
    <!-- mermaid --><meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" href="/blog/assets/css/main.css">
    <script src="https://kit.fontawesome.com/f9271f6bdd.js" crossorigin="anonymous"></script>
    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark-dimmed.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
  </head>

  <body class="font-mono list-disc">
    <div class="pt-12 pb-4">
      
        <nav class="flex flex-wrap items-center justify-center px-2 mb-6">
  <div class="container px-4 mx-auto flex flex-wrap items-center justify-center">
    <div class="w-full relative flex justify-center">
      <button type="button" onclick="toggleNavbar('navbar')"
        class="rounded-md inline-flex items-center justify-center text-gray-500 md:hidden"
        aria-expanded="false">
        <span class="sr-only">Open menu</span>
        <!-- Heroicon name: outline/menu -->
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
          stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>

    <div class="flex hidden md:block" id="navbar">
      <div class="flex flex-col md:flex-row mr-auto w-full">
         <!-- don't show Home in menu for Homepage -->
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/blog/">
          Home
        </a>
        

      <!-- dynamic menu based on navigation info in _config.yml -->
      
         <!-- don't show current page in menu -->
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/blog/about">
          About
        </a>
        
      
         <!-- don't show current page in menu -->
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/blog/category">
          Category
        </a>
        
      
    </div>
    </div>
  </div>
</nav>
        <div id="sidebar" class="p-4 fixed"></div>
      
      <div class="px-4 pt-4 prose prose-indigo">
  <h1 class="text-center mt-6 mb-6">(rails) Active Record</h1>
  <div class="text-center">
    
  </div>
  <div class="px-72">
    <h2 id="introduction">Introduction</h2>

<p>In rails, active record serves as the layer between model and database. In business environment, the persistent process of data usage and creation requires a way to connect to database persistently, so called <strong>Active Record</strong>.</p>

<ol>
  <li>Table map to classes</li>
  <li>Rows map to objects</li>
  <li>Columns map to object attributes</li>
</ol>

<h2 id="why">Why</h2>

<p>There are lots of database management system such as MySQL, SQLite, and PostgreSQL with different syntax, so ORM (object-relational mapping) born to help us for using same syntax for same purpose on different databases.</p>

<p><strong>Active Record</strong> pattern is a solution for ORM. With this pattern, we can access all data from table, User, with unified way:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User.all
</code></pre></div></div>
<p>rather than</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT * FROM User
</code></pre></div></div>
<p>and also avoid different syntax problem on different database language.</p>

<h2 id="how">How</h2>

<p>I am going to explore the following topics:</p>

<ol>
  <li>CRUD</li>
  <li>Validation</li>
  <li>Callbacks</li>
</ol>

<h3 id="crud">CRUD</h3>

<p>Please rails new a project and create a random table (I create table with <code class="language-plaintext highlighter-rouge">rails g scaffold User name:string email:string</code> and then <code class="language-plaintext highlighter-rouge">rails db:migrate</code>) and then we can create a new User with <code class="language-plaintext highlighter-rouge">test = User.create</code>.</p>

<p>To track the source code, <code class="language-plaintext highlighter-rouge">bundle open activerecord</code> and it will open the gem in <code class="language-plaintext highlighter-rouge">.rvm/gems/ruby-2.7.4/gems/activerecord-6.1.4.4/lib</code> and the source of CRUD:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">create</code>: in <code class="language-plaintext highlighter-rouge">activerecord/lib/active_record/persistence.rb</code></li>
  <li><code class="language-plaintext highlighter-rouge">find</code>: in <code class="language-plaintext highlighter-rouge">activerecord/lib/active_record/core.rb</code> (skip)</li>
  <li><code class="language-plaintext highlighter-rouge">update</code>: in <code class="language-plaintext highlighter-rouge">activerecord/lib/active_record/persistence.rb</code> (skip)</li>
  <li><code class="language-plaintext highlighter-rouge">destroy</code>: in <code class="language-plaintext highlighter-rouge">activerecord/lib/active_record/persistence.rb</code> (skip)</li>
</ol>

<p>Then we can track it with <code class="language-plaintext highlighter-rouge">binding.pry</code>. Try to find the raw SQL code. After you have done, input <code class="language-plaintext highlighter-rouge">bundle pristine activerecord</code> to recover the gems.</p>

<p>In rails console, input <code class="language-plaintext highlighter-rouge">ActiveRecord::Base.connection.adapter_name</code> to know what database system using.</p>

<p>I am going to use three sections to explain these methods</p>
<ol>
  <li>How <code class="language-plaintext highlighter-rouge">User.create</code> link to general methods of ActiveRecord of create</li>
  <li>How these general methods link the plain SQL</li>
  <li>How rails determines which plain SQL being used by connection methods</li>
  <li>The conecept of design pattern of these adapters
    <h4 id="create">create</h4>
  </li>
</ol>

<h5 id="how-usercreate-link-to-general-methods-of-activerecord-of-create">How <code class="language-plaintext highlighter-rouge">User.create</code> link to general methods of ActiveRecord of create</h5>

<p>Fire up the rails console, and input <code class="language-plaintext highlighter-rouge">User.create</code>, then the SQL would be</p>
<pre><code class="language-SQL">TRANSACTION (0.1ms)  begin transaction
User Create (0.4ms)  INSERT INTO "users" ("created_at", "updated_at") VALUES (?, ?)  [["created_at", "2022-01-11 02:01:31.475084"], ["updated_at", "2022-01-11 02:01:31.475084"]]
TRANSACTION (1.0ms)  commit transaction
</code></pre>

<p>I am using SQLite and the key issue is why rails knows to use the INSERT grammar for SQLite instead of MySQL or PG.</p>

<p>Add <code class="language-plaintext highlighter-rouge">binding.pry</code> in class as follow:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
<span class="k">end</span>
</code></pre></div></div>
<p>and input <code class="language-plaintext highlighter-rouge">User.create</code> in rails console</p>

<p>Then the data flow of <code class="language-plaintext highlighter-rouge">create</code> would be as follow:</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">create</code> method in superclass when calling <code class="language-plaintext highlighter-rouge">user.create</code> in <code class="language-plaintext highlighter-rouge">.../research_activerecord/app/models/user.rb</code></li>
  <li>the superclass of <code class="language-plaintext highlighter-rouge">User</code>: <code class="language-plaintext highlighter-rouge">ApplicationRecord</code></li>
  <li>the superclass of <code class="language-plaintext highlighter-rouge">ApplicationRecord</code>: <code class="language-plaintext highlighter-rouge">ActiveRecord::Base</code></li>
  <li>Have a look at <code class="language-plaintext highlighter-rouge">base.rb</code>
    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">ActiveRecord</span> <span class="c1">#:nodoc:</span>
  <span class="o">...</span>
  <span class="k">class</span> <span class="nc">Base</span>
 <span class="o">...</span>
 <span class="kp">extend</span> <span class="no">ConnectionHandling</span>
 <span class="o">...</span>
 <span class="kp">include</span> <span class="no">Core</span>
 <span class="kp">include</span> <span class="no">Persistence</span>
 <span class="o">...</span>
  <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>Given that we know, <code class="language-plaintext highlighter-rouge">create</code> methods equals to <code class="language-plaintext highlighter-rouge">new</code> + <code class="language-plaintext highlighter-rouge">save</code>, then in <code class="language-plaintext highlighter-rouge">Core</code>, there are methods such as <code class="language-plaintext highlighter-rouge">initialize</code> and in <code class="language-plaintext highlighter-rouge">Persistence</code>, there are methods such as <code class="language-plaintext highlighter-rouge">save</code>.</p>

<ol>
  <li>The <code class="language-plaintext highlighter-rouge">create</code> method in <code class="language-plaintext highlighter-rouge">persistence.rb</code></li>
</ol>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">attributes</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
    <span class="n">attributes</span><span class="p">.</span><span class="nf">collect</span> <span class="p">{</span> <span class="o">|</span><span class="kp">attr</span><span class="o">|</span> <span class="n">create</span><span class="p">(</span><span class="kp">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">else</span>
    <span class="n">object</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">object</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">object</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>As you can see, it will call <code class="language-plaintext highlighter-rouge">new</code> and then <code class="language-plaintext highlighter-rouge">save</code> method.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">new</code> (skip)</li>
  <li><code class="language-plaintext highlighter-rouge">save</code> in <code class="language-plaintext highlighter-rouge">persistence.rb</code> -&gt; <code class="language-plaintext highlighter-rouge">create_or_update</code> -&gt; <code class="language-plaintext highlighter-rouge">result = new_record? ? _create_record(&amp;block) : _update_record(&amp;block)</code> -&gt; <code class="language-plaintext highlighter-rouge">_create_record(&amp;block)</code> -&gt; <code class="language-plaintext highlighter-rouge">yield(self)</code> (追不下去)</li>
</ol>

<h5 id="how-these-general-methods-link-the-plain-sql">How these general methods link the plain SQL</h5>

<ol>
  <li><code class="language-plaintext highlighter-rouge">insert_all</code> in <code class="language-plaintext highlighter-rouge">.../lib/active_record/persistence.rb</code> -&gt; <code class="language-plaintext highlighter-rouge">InsertAll.new(self, attributes, on_duplicate: :skip, returning: returning, unique_by: unique_by).execute</code></li>
  <li><code class="language-plaintext highlighter-rouge">initialize(model, inserts, on_duplicate:, returning: nil, unique_by: nil)</code> in <code class="language-plaintext highlighter-rouge">.../lib/active_record/insert_all.rb</code> and the model is <code class="language-plaintext highlighter-rouge">User</code> in my case</li>
  <li><code class="language-plaintext highlighter-rouge">execute</code> in <code class="language-plaintext highlighter-rouge">.../lib/active_record/insert_all.rb</code></li>
  <li><code class="language-plaintext highlighter-rouge">execute</code> -&gt; <code class="language-plaintext highlighter-rouge">connection.exec_insert_all to_sql, message</code></li>
  <li><code class="language-plaintext highlighter-rouge">connection</code> in <code class="language-plaintext highlighter-rouge">attr_reader :connection</code>, which means
    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">connection</span>
  <span class="vi">@connection</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">@connection = model.connection</code> and <code class="language-plaintext highlighter-rouge">model</code> is the <code class="language-plaintext highlighter-rouge">self</code> in <code class="language-plaintext highlighter-rouge">InsertAll.new</code>, which is <code class="language-plaintext highlighter-rouge">User</code> in my case.</li>
  <li><code class="language-plaintext highlighter-rouge">exec_insert_all</code> in <code class="language-plaintext highlighter-rouge">database_statements.rb</code></li>
  <li><code class="language-plaintext highlighter-rouge">to_sql</code> = <code class="language-plaintext highlighter-rouge">connection.build_insert_sql(ActiveRecord::InsertAll::Builder.new(self))</code></li>
  <li><code class="language-plaintext highlighter-rouge">build_insert_sql</code> can be in <code class="language-plaintext highlighter-rouge">abstract_adapter.rb</code>, <code class="language-plaintext highlighter-rouge">abstract_mysql_adapter.rb</code>, <code class="language-plaintext highlighter-rouge">postgresql_adapter.rb</code>, or <code class="language-plaintext highlighter-rouge">sqlite3_adapter.rb</code></li>
  <li>rails determines which <code class="language-plaintext highlighter-rouge">build_insert_sql</code> to be used by <code class="language-plaintext highlighter-rouge">connection</code></li>
</ol>

<h5 id="how-rails-determines-which-plain-sql-being-used-by-connection-methods">How rails determines which plain SQL being used by connection methods</h5>

<p>Then how does it determine what SQL command to use?</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">establish_connection</code> in <code class="language-plaintext highlighter-rouge">.../lib/active_record/connection_handling.rb</code></li>
  <li>it determines which adapter to be used through <code class="language-plaintext highlighter-rouge">establish_connection</code>
    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">establish_connection</span><span class="p">(</span>
  <span class="ss">adapter:  </span><span class="s2">"mysql2"</span><span class="p">,</span>
  <span class="ss">host:     </span><span class="s2">"localhost"</span><span class="p">,</span>
  <span class="ss">username: </span><span class="s2">"myuser"</span><span class="p">,</span>
  <span class="ss">password: </span><span class="s2">"mypass"</span><span class="p">,</span>
  <span class="ss">database: </span><span class="s2">"somedatabase"</span>
<span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>and it will call <code class="language-plaintext highlighter-rouge">connection_handler</code>, which is <code class="language-plaintext highlighter-rouge">self.connection_handler</code> in <code class="language-plaintext highlighter-rouge">core.rb</code></li>
  <li>call <code class="language-plaintext highlighter-rouge">default_connection_handler</code> given there is no thread -&gt; <code class="language-plaintext highlighter-rouge">self.default_connection_handler = ConnectionAdapters::ConnectionHandler.new</code></li>
  <li><code class="language-plaintext highlighter-rouge">initialize</code> in <code class="language-plaintext highlighter-rouge">class ConnectionHandler</code> of <code class="language-plaintext highlighter-rouge">connection_pool.rb</code></li>
  <li>so it actually call <code class="language-plaintext highlighter-rouge">establish_connection</code> in <code class="language-plaintext highlighter-rouge">connection_pool.rb</code> -&gt; <code class="language-plaintext highlighter-rouge">resolve_pool_config</code> -&gt; <code class="language-plaintext highlighter-rouge">path_to_adapter = "active_record/connection_adapters/#{db_config.adapter}_adapter"</code> -&gt; <code class="language-plaintext highlighter-rouge">require path_to_adapter</code> (<strong>where the determination of adapter</strong>)</li>
  <li>Take mysql as example, it require <code class="language-plaintext highlighter-rouge">.../lib/active_record/connection_adapters/mysql2_adapter.rb</code> -&gt; <code class="language-plaintext highlighter-rouge">require "active_record/connection_adapters/abstract_mysql_adapter"</code></li>
  <li><code class="language-plaintext highlighter-rouge">build_insert_sql</code> in <code class="language-plaintext highlighter-rouge">.../lib/active_record/connection_adapters/abstract_mysql_adapter</code></li>
</ol>

<h5 id="the-conecept-of-design-pattern-of-these-adapters">The conecept of design pattern of these adapters</h5>
<p>to be continued</p>

<p>SQLite3Adapter &lt; AbstractAdapter</p>

<p>Mysql2Adapter &lt; AbstractMysqlAdapter &lt; AbstractAdapter</p>

<p>PostgreSQLAdapter &lt; AbstractAdapter</p>

<p>之後再從這裡繼續，就是要大概知道這個轉接器怎麼出來的，還有他會怎麼處理 create，至於 object or class adapter 我實在分不出來，算了</p>

<h4 id="find">find</h4>

<h4 id="update">update</h4>

<h4 id="destroy">destroy</h4>

<h3 id="validation">Validation</h3>

<p>For data to be consistent in a model, we should validate it <strong>before</strong> inserting into a database. The methods for validation in <a href="https://guides.rubyonrails.org/active_record_validations.html">Active Record Validation - Ruby on Rails</a></p>

<h3 id="callbacks">Callbacks</h3>

<p>Callback is the function that are going to be call after a function executed.</p>

<p>The life cycle of an object in a framework always plays key role. The process:
<img src="/assets/img/active_record_callbacks.png" alt="" />(reference: <a href="https://railsbook.tw/"><strong>railsbook.pdf</strong></a>)</p>

<p>The above cycle only shows the hooks of save. For more information, please refer to <a href="https://guides.rubyonrails.org/active_record_callbacks.html">active record callbacks</a></p>

<h4 id="some-interesting-queries-i-cannot-understand-it-right-now">Some interesting queries: (I cannot understand it right now)</h4>

<p><strong>Iteration</strong>: If we want to send an email to all users</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Customer.all.each do |customer|
  NewsMailer.weekly(customer).deliver_now
end
</code></pre></div></div>
<p>However, the <code class="language-plaintext highlighter-rouge">.all</code> takes too much memory; as a result, we can use <code class="language-plaintext highlighter-rouge">find_each</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Customer.find_each(batch_size: 5000) do |customer|
  NewsMailer.weekly(customer).deliver_now
end
</code></pre></div></div>
<p>to portion the table and read it in a batch size many times.</p>

<p>The source code of <code class="language-plaintext highlighter-rouge">find_each</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def find_each(start: nil, finish: nil, batch_size: 1000, error_on_ignore: nil, order: :asc)
  if block_given?
    find_in_batches(start: start, finish: finish, batch_size: batch_size, error_on_ignore: error_on_ignore, order: order) do |records|
      records.each { |record| yield record }
    end
  else
    enum_for(:find_each, start: start, finish: finish, batch_size: batch_size, error_on_ignore: error_on_ignore, order: order) do
      relation = self
      apply_limits(relation, start, finish, order).size
    end
  end
end
</code></pre></div></div>
<p>The source code of <code class="language-plaintext highlighter-rouge">find_in_batches</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def find_in_batches(start: nil, finish: nil, batch_size: 1000, error_on_ignore: nil, order: :asc)
  relation = self
  unless block_given?
    return to_enum(:find_in_batches, start: start, finish: finish, batch_size: batch_size, error_on_ignore: error_on_ignore, order: order) do
      total = apply_limits(relation, start, finish, order).size
      (total - 1).div(batch_size) + 1
    end
  end

  in_batches(of: batch_size, start: start, finish: finish, load: true, error_on_ignore: error_on_ignore, order: order) do |batch|
    yield batch.to_a
  end
end
</code></pre></div></div>
<p>The source code of <code class="language-plaintext highlighter-rouge">in_batches</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def in_batches(of: 1000, start: nil, finish: nil, load: false, error_on_ignore: nil, order: :asc)
  relation = self
  unless block_given?
    return BatchEnumerator.new(of: of, start: start, finish: finish, relation: self)
  end

  unless [:asc, :desc].include?(order)
    raise ArgumentError, ":order must be :asc or :desc, got #{order.inspect}"
  end

  if arel.orders.present?
    act_on_ignored_order(error_on_ignore)
  end

  batch_limit = of
  if limit_value
    remaining   = limit_value
    batch_limit = remaining if remaining &lt; batch_limit
  end

  relation = relation.reorder(batch_order(order)).limit(batch_limit)
  relation = apply_limits(relation, start, finish, order)
  relation.skip_query_cache! # Retaining the results in the query cache would undermine the poinof batching
  batch_relation = relation

  loop do
    if load
      records = batch_relation.records
      ids = records.map(&amp;:id)
      yielded_relation = where(primary_key =&gt; ids)
      yielded_relation.load_records(records)
    else
      ids = batch_relation.pluck(primary_key)
      yielded_relation = where(primary_key =&gt; ids)
    end

    break if ids.empty?

    primary_key_offset = ids.last
    raise ArgumentError.new("Primary key not included in the custom select clause") unlesprimary_key_offset

    yield yielded_relation

    break if ids.length &lt; batch_limit

    if limit_value
      remaining -= ids.length

      if remaining == 0
        # Saves a useless iteration when the limit is a multiple of the
        # batch size.
        break
      elsif remaining &lt; batch_limit
        relation = relation.limit(remaining)
      end
    end

    batch_relation = relation.where(
      predicate_builder[primary_key, primary_key_offset, order == :desc ? :lt : :gt]
    )
  end
end
</code></pre></div></div>

<h3 id="association">Association</h3>
<p>For more detail, please refer to <a href="https://guides.rubyonrails.org/association_basics.html"><strong>Active Record - Association</strong></a>. Some interesting association: polymorphic, STI, polymorphic + STI</p>

<h4 id="polymorphic">polymorphic</h4>
<p>We should use <code class="language-plaintext highlighter-rouge">polymorphic</code>, if a model belongs to more than one model and the meaning of the <code class="language-plaintext highlighter-rouge">belongs_to</code> are almost the same. However, if the <code class="language-plaintext highlighter-rouge">belongs_to</code> has significantly different meanings, then we should use multiple <code class="language-plaintext highlighter-rouge">has_many</code> and <code class="language-plaintext highlighter-rouge">belongs_to</code> rather than <code class="language-plaintext highlighter-rouge">polymorphic</code>. For example, both product and user can be commented, so we can create <code class="language-plaintext highlighter-rouge">Comment</code> model with</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rails g model Comment commentable_type:string commentable_id:integer body:text
</code></pre></div></div>
<p>and the model setting would be as follow:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Comment &lt; ApplicationRecord
  belongs_to :commentable, polymorphic: true
end

class Product &lt; ApplicationRecord
  has_many :comments, as: :commentable
end

class User &lt; ApplicationRecord
  has_many :comments, as: :commentable
end
</code></pre></div></div>
<p>As the setting above, the <code class="language-plaintext highlighter-rouge">commentable_id</code> will save the id of <code class="language-plaintext highlighter-rouge">product</code> and <code class="language-plaintext highlighter-rouge">user</code> and because of the <code class="language-plaintext highlighter-rouge">commentable_type</code>, no worries if the id of <code class="language-plaintext highlighter-rouge">product</code> and <code class="language-plaintext highlighter-rouge">user</code> are the same.</p>

<p>Note that the structure can be written as follow:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Comment &lt; ApplicationRecord
  belongs_to :product
  belongs_to :user
end

class Product &lt; ApplicationRecord
  has_many :comments
end

class User &lt; ApplicationRecord
  has_many :comments
end
</code></pre></div></div>

<h4 id="sti-single-table-inheritance">STI (single table inheritance)</h4>
<p>When to use <code class="language-plaintext highlighter-rouge">single table inheritance</code>? (skip)</p>

<h4 id="polymorphic--sti">Polymorphic + STI</h4>
<p>For example, if we want to setup a platform and users can be both employer and employee for a task and each task can only have one employer and employee.</p>

<p>Then, the model setups would be</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Task &lt; ActiveRecord::Base
  belongs_to :liable, polymorphic: true

  def liable_type=(class_name)
    super(class_name.constantize.base_class.to_s)
  end
end

class User &lt; Active::Base
  has_many :task, as: :liable, dependent: :destroy
end

class Employer &lt; User
  has_and_belongs_to_many :employess
end

class Employee &lt; User
  has_and_belongs_to_many :employers
end
</code></pre></div></div>
<p>Notice! Employer and Employee use the concept of STI(Single-table inheritance).</p>

<h2 id="reference">Reference</h2>

<p><a href="https://zh.wikipedia.org/wiki/Active_Record"><strong>Active Record - 维基百科，自由的百科全书</strong></a></p>

<p><a href="https://guides.rubyonrails.org/active_record_basics.html"><strong>Active Record - Ruby on Rails</strong></a></p>

<p><a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#label-Polymorphic+Associations"><strong>polymorphic + STI</strong></a></p>

<p><a href="https://eng.localytics.com/odbc-and-writing-your-own-activerecord-adapter/">ODBC and writing your own ActiveRecord adapter</a></p>

<p>(http://www.monkeyandcrow.com/blog/reading_rails_the_adapter_pattern/)</p>

  </div>
</div>

<footer class="relative px-4 pt-4 pb-4">
  
  <!-- divider -->
  <div class="relative my-8">
    <div class="absolute inset-0 flex items-center" aria-hidden="true">
      <div class="w-full border-t border-gray-200"></div>
    </div>
    <div class="relative flex justify-center ">
      <span class="bg-white px-2 text-gray-200">
        <i class="text-xs far fa-square"></i>
      </span>
    </div>
  </div>

  <!-- footer msg -->
  <div class="flex flex-wrap items-center justify-center">
    <div class="text-sm text-gray-300">
      © <span id="get-current-year"></span>
      
      <a href="" class="!no-underline">
        
      </a>
      
    </div>
  </div>
  </div>
</footer>

<script type="text/javascript" src="/blog/assets/javascripts/bundle.js" charset="utf-8"></script>

    </div>
  </body>

  <script>
    /* Funtion for getting the current year in the footer */
    (function () {
      if (document.getElementById("get-current-year")) {
        document.getElementById(
          "get-current-year"
        ).innerHTML = new Date().getFullYear();
      }
    })();

    /* Function for opning navbar on mobile */
    function toggleNavbar(collapseID) {
        document.getElementById(collapseID).classList.toggle("hidden");
        document.getElementById(collapseID).classList.toggle("block");
      }
      /* Function for dropdowns */
      function openDropdown(event, dropdownID) {
        let element = event.target;
        while (element.nodeName !== "A") {
          element = element.parentNode;
        }
        document.getElementById(dropdownID).classList.toggle("hidden");
        document.getElementById(dropdownID).classList.toggle("block");
      }
  </script>
</html>
