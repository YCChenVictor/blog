<!DOCTYPE html>
<html lang="en-US">
  <head>
    

    

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <link rel="stylesheet" href="/blog/assets/css/main.css">
    <script src="https://kit.fontawesome.com/f9271f6bdd.js" crossorigin="anonymous"></script>
    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark-dimmed.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
  </head>

  <body class="font-mono list-disc bg-gray-700">
    <div class="pt-8 bg-gray-700">
      
        <nav class="flex flex-wrap items-center justify-center px-2 py-4 mb-6">
  <div class="titleImagePosition">
    <a href="/blog/" class="!px-0 !py-0">
      <img class="titleImage" src="/blog/assets/img/title.jpeg" alt="author profile image">
    </a>
  </div>
  <div class="flex">
    <div class="container px-4 mx-auto flex flex-wrap items-center justify-center">
      <div class="absolute right-16 flex md:block" id="navbar">
        <div class="flex flex-col md:flex-row mr-auto w-full">
          <!-- dynamic menu based on navigation info in _config.yml -->
          
             <!-- don't show current page in menu -->
              <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 mx-auto uppercase"
                href="/blog/about">
                About Me
              </a>
            
          
        </div>
      </div>
    </div>
  </div>
</nav>

      
      
  <div id='sidebar' class='fixed py-16 hidden lg:block'></div>
  <div id='burger-sidebar' class='pt-24 pl-4 fixed hidden md:block'></div>

<div class='prose bg-gray-400' id='article'>
  <div id='word-count' class='pt-4 pl-8 fixed'>words: 80</div>
  <div class='text-center'>
    
  </div>
  <div class='md:px-4 md:grid lg:px-72'>
    <h1 class='text-center mt-6 mb-6'>Model</h1>
    <h2 id="introduction">Introduction</h2>

<ul>
  <li>A model is a Ruby class that is used to represent data. Additionally, models can interact with the application’s database through a feature of Rails called <a href="/blog/rails/2021/06/10/active-record.html">Active Record</a></li>
  <li>An object refers to an instance of a class, which represents a single record in a database table.</li>
</ul>

<p>In this article, I am not going to research how rails code methods in model, so in how section will be basic coding examples for me to understand the concepts. Please refer to <a href="/blog/rails/2021/06/10/active-record.html">Active Record</a> to see how rails code the default model methods.</p>

<h2 id="why">Why</h2>

<p>With model, we can use consistent commands to communicate with all type of databases such as MySQL, Postgresql, …etc.</p>

<h2 id="how">How</h2>

<h3 id="create-model">Create Model</h3>

<p>Define a Ruby class that inherits from the ActiveRecord::Base class. This class will represent a table in your database, and the properties of the class will map to columns in the table. Here is an example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this example, we have defined a <code class="language-plaintext highlighter-rouge">User</code> class that inherits from <code class="language-plaintext highlighter-rouge">ActiveRecord::Base</code>. This class will represent a table called users in our database (convention), and it will have properties that map to columns in the users table.</p>

<p>Then we can interact with database with this model:</p>

<ul>
  <li>create
    <ul>
      <li>Create a new record
        <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'John'</span><span class="p">,</span> <span class="ss">email: </span><span class="s1">'john@example.com'</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">save</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>read
    <ul>
      <li>Query records
        <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">age: </span><span class="mi">18</span><span class="o">..</span><span class="mi">35</span><span class="p">)</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>update
    <ul>
      <li>Update a record
        <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'John'</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">email</span> <span class="o">=</span> <span class="s1">'new_email@example.com'</span>
<span class="n">user</span><span class="p">.</span><span class="nf">save</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="relation">relation</h3>

<p>Relations in Rails models establish associations between different model classes, enabling developers to define and navigate the relationships between data entities. These relationships can be expressed through various types such as one-to-one, one-to-many, and many-to-many, allowing for efficient querying, data retrieval, and manipulation within the Rails framework. For more information, please refer to <a href="/blog/rails/2021/03/03/relation.html">relation</a></p>

<h3 id="validation">validation</h3>

<p>Validation in Rails models ensures the accuracy and validity of data. By defining validation rules, such as presence, uniqueness, or format constraints, you can maintain data integrity and provide meaningful error messages to users. For more information, please refer to <a href="/blog/rails/2021/03/03/relation.html">validation</a>.</p>

<h3 id="callback">callback</h3>

<p>The full life cycle of an object in rails:</p>

<ul>
  <li>Initialization: The object is created in memory with default attribute values.</li>
  <li>before_validation: Called before validation occurs.</li>
  <li>Validation: The object’s attributes are validated to ensure they meet specified constraints or requirements.</li>
  <li>after_validation: Called after validation occurs.</li>
  <li>before_save: Called before the object is saved.</li>
  <li>Database write: The object’s attributes are written to the database.</li>
  <li>around_save: Called around the object save.</li>
  <li>after_save: Called after the object is saved.</li>
  <li>before_create: Called before a new record is created.</li>
  <li>around_create: Called around a new record creation.</li>
  <li>after_create: Called after a new record is created.</li>
  <li>before_update: Called before an existing record is updated.</li>
  <li>around_update: Called around an existing record update.</li>
  <li>after_update: Called after an existing record is updated.</li>
  <li>before_destroy: Called before a record is destroyed.</li>
  <li>around_destroy: Called around a record destruction.</li>
  <li>after_destroy: Called after a record is destroyed.</li>
</ul>

<p>Not all steps of the lifecycle are always executed. For example, if an object fails validation, the before_save, around_save, after_save, before_create, around_create, and after_create callbacks won’t be executed.</p>

<ul>
  <li>coding example</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:normalize_name</span>
  <span class="n">before_create</span> <span class="ss">:encrypt_email</span>
  <span class="n">after_create</span> <span class="ss">:send_welcome_email</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">normalize_name</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span><span class="p">.</span><span class="nf">downcase</span><span class="p">.</span><span class="nf">titleize</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">send_welcome_email</span>
    <span class="no">UserMailer</span><span class="p">.</span><span class="nf">welcome_email</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_now</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">encrypt_email</span>  
    <span class="nb">self</span><span class="p">.</span><span class="nf">email</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>  
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="scope">scope</h3>

<p>Scopes are defined as class methods on a model and return a relation object, which can be further chained with other query methods to narrow down the results.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">scope</span> <span class="ss">:available</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">in_stock: </span><span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:priced_above</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">'price &gt; ?'</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># Retrieve all available products</span>
<span class="no">Product</span><span class="p">.</span><span class="nf">available</span>

<span class="c1"># Retrieve all products priced above $50</span>
<span class="no">Product</span><span class="p">.</span><span class="nf">priced_above</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Combine scopes with other query methods</span>
<span class="no">Product</span><span class="p">.</span><span class="nf">available</span><span class="p">.</span><span class="nf">priced_above</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="what">What</h2>

<h3 id="real-world-example">real world example</h3>

<p>E-commerce application:</p>

<ul>
  <li>three models
    <ul>
      <li>Product: The Product model represents a specific item that can be sold on the website</li>
      <li>Order: The Order model represents a single order that a customer has placed on the website.</li>
      <li>LineItem: The LineItem model represents a specific item that a customer has added to their cart while shopping.</li>
    </ul>
  </li>
  <li>A Product can have many LineItems, and a LineItem belongs to a Product and an Order. An Order can have many LineItems.</li>
  <li>settings:
    <ul>
      <li>Product
        <ul>
          <li>If a Product is destroyed, all its associated LineItems should be destroyed too</li>
          <li>Validation that requires name and price to be present.</li>
        </ul>
      </li>
      <li>Order
        <ul>
          <li>If an Order is destroyed, all its associated LineItems should be destroyed too. * Validations that require name and email to be present</li>
          <li>Callback that set the initial status of the Order to “pending”</li>
          <li>Callback to update the subtotal of the Order whenever a LineItem is saved.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:line_items</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:line_items</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">before_create</span> <span class="ss">:set_order_status</span>
  <span class="n">before_save</span> <span class="ss">:update_subtotal</span>

  <span class="k">def</span> <span class="nf">subtotal</span>
    <span class="n">line_items</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:total_price</span><span class="p">).</span><span class="nf">sum</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">set_order_status</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">status</span> <span class="o">=</span> <span class="s1">'pending'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update_subtotal</span>
    <span class="nb">self</span><span class="p">[</span><span class="ss">:subtotal</span><span class="p">]</span> <span class="o">=</span> <span class="n">subtotal</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">LineItem</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:product</span>
  <span class="n">belongs_to</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:product_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">numericality: </span><span class="p">{</span> <span class="ss">only_integer: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">greater_than: </span><span class="mi">0</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nf">total_price</span>
    <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="o">*</span> <span class="n">quantity</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In the LineItem model, we define a belongs_to association with Product and Order. We also add two validations that require the product_id to be present and the quantity to be greater than zero, as well as a method that calculates the total price of the line item.</p>

<p>With these relationships, validations, and callbacks in place, we can easily create, update, and delete products, orders, and line items in our e-commerce application.</p>

<h2 id="reference">Reference</h2>

<p><a href="&quot;https://railsbook.tw/&quot;">為你自己學 Ruby on Rails 高見龍</a></p>

<p><a href="https://rubyinrails.com/2014/05/14/rails-migration-change-vs-up-down-methods/">change vs up &amp; down</a></p>

<p><a href="https://guides.rubyonrails.org/getting_started.html">Getting Started with Rails</a></p>

  </div>
</div>

<footer class="relative px-4 pt-4 pb-4">
    <!-- footer msg -->
  <div class="flex flex-wrap items-center justify-center">
    <br>
  </div>
</footer>

      <button
        type="button"
        data-mdb-ripple="true"
        data-mdb-ripple-color="light"
        class="scrollTopBtn"
        id="btn-back-to-top"
      >
        <svg aria-hidden="true" focusable="false" data-prefix="fas" class="w-4 h-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"></path></svg>
      </button>
    </div>
  </body>

  <script>
    /* Function for getting the current year in the footer */
    (function () {
      if (document.getElementById("get-current-year")) {
        document.getElementById(
          "get-current-year"
        ).innerHTML = new Date().getFullYear();
      }
    })();
    /* Function for opening navbar on mobile */
    function toggleNavbar(collapseID) {
        document.getElementById(collapseID).classList.toggle("hidden");
        document.getElementById(collapseID).classList.toggle("block");
      }
    /* Function for dropdowns */
    function openDropdown(event, dropdownID) {
      let element = event.target;
      while (element.nodeName !== "A") {
        element = element.parentNode;
      }
      document.getElementById(dropdownID).classList.toggle("hidden");
      document.getElementById(dropdownID).classList.toggle("block");
    }

    // Get the button
    let myButton = document.getElementById("btn-back-to-top");
    // When the user scrolls down 20px from the top of the document, show the button
    window.onscroll = function () {
      scrollFunction();
    };
    function scrollFunction() {
      if (
        document.body.scrollTop > 20 ||
        document.documentElement.scrollTop > 20
      ) {
        myButton.style.display = "block";
      } else {
        myButton.style.display = "none";
      }
    }
    // When the user clicks on the button, scroll to the top of the document
    myButton.addEventListener("click", backToTop);
    function backToTop() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }
  </script>

  <script type="text/javascript" src="/blog/assets/javascript/bundle.js" charset="utf-8"></script>
</html>
