<!DOCTYPE html>
<html lang="en-US">
  <head>
    

    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.6/mermaid.min.js"></script>
<script>
  const config = {
    theme: 'neutral',
    startOnLoad:true,
    htmlLabels:true,
  };
  mermaid.initialize(config);
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <link rel="stylesheet" href="/blog/assets/css/main.css">
    <script src="https://kit.fontawesome.com/f9271f6bdd.js" crossorigin="anonymous"></script>
    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark-dimmed.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
  </head>

  <body class="font-mono list-disc bg-gray-700">
    <div class="pt-8 bg-gray-700">
      
        <nav class="flex flex-wrap items-center justify-center px-2 py-4 mb-6">
  <div class="titleImagePosition">
    <a href="/blog/" class="!px-0 !py-0">
      <img class="titleImage" src="/blog/assets/img/title.jpeg" alt="author profile image">
    </a>
  </div>
  <div class="flex">
    <div class="container px-4 mx-auto flex flex-wrap items-center justify-center">
      <div class="absolute right-16 flex md:block" id="navbar">
        <div class="flex flex-col md:flex-row mr-auto w-full">
          <!-- dynamic menu based on navigation info in _config.yml -->
          
             <!-- don't show current page in menu -->
              <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 mx-auto uppercase"
                href="/blog/about">
                About Me
              </a>
            
          
        </div>
      </div>
    </div>
  </div>
</nav>

      
      
  <div id='sidebar' class='fixed py-16 hidden lg:block'></div>
  <div id='burger-sidebar' class='pt-24 pl-4 fixed hidden md:block'></div>

<div class='prose bg-gray-400' id='article'>
  <div id='word-count' class='pt-4 pl-8 fixed'>words: 80</div>
  <div class='text-center'>
    
  </div>
  <div class='md:px-4 md:grid lg:px-72'>
    <h1 class='text-center mt-6 mb-6'>Relation</h1>
    <h2 id="introduction">Introduction</h2>

<p>(TBC)</p>

<h2 id="why">Why</h2>

<p>(TBC)</p>

<h2 id="how">How</h2>

<h3 id="types-of-associations">Types of Associations</h3>

<p>Rails provides several types of associations to represent different relationships between models, such as belongs_to, has_many, has_one, and has_and_belongs_to_many. It’s crucial to grasp the purpose and usage of each association type to establish correct and efficient relationships between models.</p>

<ul>
  <li>belongs_to: Used to define a one-to-many relationship between two tables</li>
  <li>has_many: Used to define a one-to-many relationship between two tables</li>
  <li>has_one: Used to define a one-to-one relationship between two tables</li>
  <li>example: We have a User model, a Profile model, and a Post model. Each user has one profile, and each user can have many posts. Each post belongs to a user.</li>
</ul>

<p>To define these associations,</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:profile</span>
  <span class="n">has_many</span> <span class="ss">:posts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Profile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">has_one</span> <span class="ss">:profile</span><span class="p">,</span> <span class="ss">through: :user</span> <span class="c1"># because user has one profile and also has many posts</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This tells Rails that each User has one Profile, and that each User can have many Posts. It also tells Rails that each Profile belongs to a User, and that each Post belongs to a User. By default, Rails assumes that the posts table has a foreign key called user_id that references the id column of the users table.</p>

<p>Access related data:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="vi">@profile</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">profile</span>

<span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="vi">@posts</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">posts</span>

<span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="vi">@user</span> <span class="o">=</span> <span class="vi">@post</span><span class="p">.</span><span class="nf">user</span>

<span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
<span class="vi">@profile</span> <span class="o">=</span> <span class="vi">@post</span><span class="p">.</span><span class="nf">profile</span>
</code></pre></div></div>

<h3 id="declaring-associations">Declaring Associations</h3>

<p>Associations are declared within Rails model classes using appropriate methods provided by ActiveRecord, the ORM (Object-Relational Mapping) layer in Rails. By utilizing these methods, you can define the relationships between models and specify options like foreign keys, dependent actions, and eager loading behaviors.</p>

<h3 id="querying-and-manipulating-related-data">Querying and Manipulating Related Data</h3>

<p>Once associations are set up, you can leverage them to query and manipulate related data effectively. Rails provides methods like includes, joins, and eager loading associations to optimize database queries and minimize the number of database hits. Additionally, understanding methods like build, create, and destroy helps in creating and managing related records conveniently.</p>

<h2 id="what">What</h2>

<p>For example, if we want to build an online store system. The relations:</p>

<ul>
  <li>One-to-one: every user can create one store</li>
  <li>One-to-many: a store can sell many products</li>
  <li>Many-to-many: Each store can sell many products and each product can be sold in many stores</li>
</ul>

<h3 id="one-to-one">one-to-one</h3>

<ul>
  <li>Visualization
    <div class="mermaid">
classDiagram
  direction LR
  class User{
    -id : int
    -name : string
    -email: string
    -tel: int
  }
  class Store{
    -id : int
    -title: string
    -address: string
    -tel: int
    -user_id: int
  }
  User "1" --o "1" Store : has_one
</div>
  </li>
  <li>Generate <code class="language-plaintext highlighter-rouge">User</code> and <code class="language-plaintext highlighter-rouge">Store</code> model
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails g model User name email tel
rails g model Store title tel address user_id:integer
<span class="c"># or</span>
rails g model Store title tel address user:references

rails db:migrate
</code></pre></div>    </div>
    <p><code class="language-plaintext highlighter-rouge">user_id:integer</code> makes <code class="language-plaintext highlighter-rouge">Store</code> to have foreign key matching id in User database.</p>
  </li>
  <li>Before setting relation in model, if we directly create <code class="language-plaintext highlighter-rouge">user</code> and <code class="language-plaintext highlighter-rouge">store</code> and build relation as follow:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user1 = User.new(name: "aaa")
store1 = Store.new(title: "aaa")
user1.store = store1
</code></pre></div>    </div>
    <ul>
      <li>Error
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NoMethodError (undefined method `store=' for #&lt;User:0x00000001212dada8&gt;)
</code></pre></div>        </div>
        <p>,meaning the user does not have the method to set relation with store, setting relation up as follow</p>
      </li>
    </ul>
  </li>
  <li>Solve errors
    <ul>
      <li>In user model,
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class User &lt; ApplicationRecord  
  has_one :store  
end
</code></pre></div>        </div>
      </li>
      <li>In store model,
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Store &lt; ApplicationRecord  
  belongs_to :user  
end
</code></pre></div>        </div>
      </li>
      <li>Then we can use model to manipulate database with model as follow
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user1.store = store1
or
store1.user = user1

user1.save
</code></pre></div>        </div>
        <p><img src="/blog/assets/img/1__4____gMZvS0GRwn01ADm__BGA.png" alt="" /></p>
        <ul>
          <li>As you can see, there are two <code class="language-plaintext highlighter-rouge">INSERT</code>. One for <code class="language-plaintext highlighter-rouge">user1</code> and one for <code class="language-plaintext highlighter-rouge">store1</code> because there is relation set up above.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="one-to-many">one-to-many</h3>

<p>Let’s build Product model</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rails g model Product name description:text price:decimal is_available:boolean store_id:integer
</code></pre></div></div>
<p>and</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rails db:migrate
</code></pre></div></div>
<p><img src="/assets/img/1__oP9w1ETe5aCdLpGVaHMuvw.png" alt="" /></p>

<p>Then add the relation in model</p>

<p>In store model,</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Store &lt; ApplicationRecord  
  belongs_to :user  
  has_many :products  
end
</code></pre></div></div>
<p>In product model</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Product &lt; ApplicationRecord  
  belongs_to :store  
end
</code></pre></div></div>
<h4 id="create-products"><strong>Create products</strong></h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>product1 = Product.new(name: "aaa", price: 100)  
product2 = Product.new(name: "bbb", price: 200)
</code></pre></div></div>
<h4 id="appoint-store"><strong>Appoint store</strong></h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>store1 = Store.first
</code></pre></div></div>
<h4 id="move-product-intostore"><strong>move product into store</strong></h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>store1.products = [product1, product2]
</code></pre></div></div>

<h3 id="scope-in-has_many">scope in has_many</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>has_many :comments, -&gt; { where(author_id: 1) }
</code></pre></div></div>
<p>Use lambda function to specify the scope of this has_many</p>

<h3 id="many-to-many">many-to-many</h3>

<h4 id="create-warehouse-for-the-following-relation"><strong>Create WareHouse for the following relation</strong></h4>
<p><img src="/blog/assets/img/1__skqUNFZZ2K721CheqeKqUw.png" alt="" /></p>

<p>Then through warehouse, store and product have the many-to-many relation</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rails g model WareHouse store:references product:references
</code></pre></div></div>
<p>Then</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rails db:migrate
</code></pre></div></div>
<p>Then in Store model</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Store &lt; ApplicationRecord  
  belongs_to :user  
    
  has_many :ware_houses  
  has_many :products, through: :ware_houses  
end
</code></pre></div></div>
<p>and in Product</p>

<p>class Product &lt; ApplicationRecord<br />
  belongs_to :store<br />
  has_many :stores, through: :ware_houses<br />
end</p>

<p>Then the relation:
<img src="/assets/img/1__5uu__eoVOcShF4bYAryrKTw.png" alt="" /></p>

<h4 id="habtm-has_and_belongs_to_many">HABTM (has_and_belongs_to_many)</h4>

<p>To deal with many-to-many structure, there is another way to set the model. For example, we can rewrite store and product into</p>

<p><strong>Store</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Store &lt; ApplicationRecord  
  has_and_belongs_to_many :products  
end
</code></pre></div></div>
<p><strong>Product</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Product &lt; ApplicationRecord  
  has_and_belongs_to_many: stores  
end
</code></pre></div></div>
<p>Notice, because there is no command to specify the middle table, warehouse, by default, rails will looking for products_stores.</p>

<p>We can reset the above models and do migration again.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rails g migration create_join_table_for_store_and_product
</code></pre></div></div>
<p>With <code class="language-plaintext highlighter-rouge">HABTM</code>, there will be no <code class="language-plaintext highlighter-rouge">warehouse</code> model for us to do more model manipulation.</p>

<h3 id="add-relations-explicitly">Add Relations Explicitly</h3>

<p>If we found that a model should have relation with another model and both models have been created,</p>

<h4 id="add-reference">add reference</h4>

<p>For example, if we want to add reference to model, Post with model, User. Then,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rails g migration AddUserToPosts user:references
</code></pre></div></div>

<p>Rails will create</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class AddUserToPosts &lt; ActiveRecord::Migration[6.1]  
  def change  
    add_reference :posts, :user, null: false, foreign_key: true  
  end  
end
</code></pre></div></div>
<p>in <code class="language-plaintext highlighter-rouge">db/migrate</code></p>

<h3 id="reference">Reference</h3>

<p><a href="&quot;https://railsbook.tw/&quot;"><strong>為你自己學 Ruby on Rails 高見龍</strong></a></p>

  </div>
</div>

<footer class="relative px-4 pt-4 pb-4">
    <!-- footer msg -->
  <div class="flex flex-wrap items-center justify-center">
    <br>
  </div>
</footer>

      <button
        type="button"
        data-mdb-ripple="true"
        data-mdb-ripple-color="light"
        class="scrollTopBtn"
        id="btn-back-to-top"
      >
        <svg aria-hidden="true" focusable="false" data-prefix="fas" class="w-4 h-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"></path></svg>
      </button>
    </div>
  </body>

  <script>
    /* Function for getting the current year in the footer */
    (function () {
      if (document.getElementById("get-current-year")) {
        document.getElementById(
          "get-current-year"
        ).innerHTML = new Date().getFullYear();
      }
    })();
    /* Function for opening navbar on mobile */
    function toggleNavbar(collapseID) {
        document.getElementById(collapseID).classList.toggle("hidden");
        document.getElementById(collapseID).classList.toggle("block");
      }
    /* Function for dropdowns */
    function openDropdown(event, dropdownID) {
      let element = event.target;
      while (element.nodeName !== "A") {
        element = element.parentNode;
      }
      document.getElementById(dropdownID).classList.toggle("hidden");
      document.getElementById(dropdownID).classList.toggle("block");
    }

    // Get the button
    let myButton = document.getElementById("btn-back-to-top");
    // When the user scrolls down 20px from the top of the document, show the button
    window.onscroll = function () {
      scrollFunction();
    };
    function scrollFunction() {
      if (
        document.body.scrollTop > 20 ||
        document.documentElement.scrollTop > 20
      ) {
        myButton.style.display = "block";
      } else {
        myButton.style.display = "none";
      }
    }
    // When the user clicks on the button, scroll to the top of the document
    myButton.addEventListener("click", backToTop);
    function backToTop() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }
  </script>

  <script type="text/javascript" src="/blog/assets/javascript/bundle.js" charset="utf-8"></script>
</html>
