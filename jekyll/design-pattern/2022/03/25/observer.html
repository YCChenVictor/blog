<h2 id="introduction">Introduction</h2>

<p>Apple fans (果粉) really want new iphone, so they keep visiting store everyday to check whether new iphone released. The company feels disturbed, so they decided to send the release information through advertisements and broadcasts. But in this time, people not interested complain that they do not want to see this information.</p>

<div class="mermaid">
graph TD
  id2(fan 1) --visit--&gt; id1(apple store)
  id3(fan 2) --visit--&gt; id1(apple store)
  id4(fan 3) --visit--&gt; id1(apple store)
  id5(fan 4) --visit--&gt; id1(apple store)
</div>

<p>Bad solution: (broadcast randomly), which will notify someone not interested or skip some fans</p>

<div class="mermaid">
graph TD
  id1(apple store) --broadcast--&gt; id2(fan 1)
  id1(apple store) --broadcast--&gt; id3(fan 2)
  id1(apple store) --broadcast--&gt; id4(bystander 1)
  id1(apple store) --broadcast--&gt; id5(fan 4)
  id1(apple store) --broadcast--&gt; id6(...)
</div>

<p>To solve this problem, Apple lets people visiting store for new iphone information to leave email so that the company can send notifications to these people when new iphone released. The notification is just like observer pattern.</p>

<p>Better solution:</p>

<div class="mermaid">
graph TD
  subgraph Observer Pattern
    id1(observer) -- observes --&gt; id2(apple store)
  end
  subgraph Broadcast
    id1(observer) --broadcast--&gt; id3(fan 1)
    id1(observer) --broadcast--&gt; id4(fan 2)
    id1(observer) --broadcast--&gt; id5(fan 3)
    id1(observer) --broadcast--&gt; id6(...other fans)
  end
</div>

<h2 id="why">Why?</h2>

<p>pros:</p>

<ul>
  <li>Open/Closed Principle. You can introduce new observers classes without having to change the observable’s code (and vice versa).</li>
</ul>

<p>cons:</p>

<ul>
  <li>Subscribers are notified in random order.</li>
</ul>

<h2 id="how">How?</h2>

<ol>
  <li>One to many relationship (one observable (apple store) to many observers (fans))</li>
  <li>The state of observable changed and all observers are notified</li>
</ol>

<div class="mermaid">
graph LR
  id1((Observable)) -- push: I changed status --&gt; id2((observers))
  id1((Observable)) -- push: I changed status --&gt; id3((observers))
  id1((Observable)) -- push: I changed status --&gt; ...
</div>

<p>and the UML (suppose fans can receive release information through phone and computer)</p>

<div class="mermaid">
classDiagram
  direction RL
  InterfaceObservable --&gt; InterfaceObserver : has many

  InterfaceObservable : add(observer)
  InterfaceObservable : remove(observer)
  InterfaceObservable : notify()

  InterfaceObserver : update()

  InterfaceObservable &lt;-- StoreObservable : is a
  InterfaceObserver &lt;-- StoreObserverA : is a
  InterfaceObserver &lt;-- StoreObserverB : is a

  StoreObservable : add(InterfaceObserver)
  StoreObservable : remove(InterfaceObserver)
  StoreObservable : notify()
  StoreObservable : business_logic()

  StoreObserverA : update()

  StoreObserverB : update()
</div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">update</code>: How observer reacts to observable events</li>
  <li><code class="language-plaintext highlighter-rouge">add</code>: Let observers to observe</li>
  <li><code class="language-plaintext highlighter-rouge">remove</code>: disable observers to observe</li>
  <li><code class="language-plaintext highlighter-rouge">notify</code>: how observable object want observers to react</li>
  <li><code class="language-plaintext highlighter-rouge">business_logic</code>: the business logic of observable and observers can react accordingly</li>
</ul>

<h2 id="what">What?</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">InterfaceObservable</span>
  <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
    <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2"> has not implemented method '</span><span class="si">#{</span><span class="n">__method__</span><span class="si">}</span><span class="s2">'"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
    <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2"> has not implemented method '</span><span class="si">#{</span><span class="n">__method__</span><span class="si">}</span><span class="s2">'"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">notify</span>
    <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2"> has not implemented method '</span><span class="si">#{</span><span class="n">__method__</span><span class="si">}</span><span class="s2">'"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">InterfaceObserver</span>
  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">_subject</span><span class="p">)</span>
    <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2"> has not implemented method '</span><span class="si">#{</span><span class="n">__method__</span><span class="si">}</span><span class="s2">'"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">StoreObservable</span> <span class="o">&lt;</span> <span class="no">InterfaceObservable</span>
  <span class="nb">attr_accessor</span> <span class="ss">:state</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@observers</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
    <span class="vi">@observers</span> <span class="o">&lt;&lt;</span> <span class="n">observer</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
    <span class="vi">@observers</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">notify</span>
    <span class="vi">@observers</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">observer</span><span class="o">|</span> <span class="n">observer</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">business_logic</span>
    <span class="vi">@state</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'new iphone released'</span><span class="p">,</span> <span class="s1">'no new iphone released'</span><span class="p">].</span><span class="nf">sample</span> <span class="c1"># simulate the business logic going to change the state of the observable</span>

    <span class="nb">puts</span> <span class="s2">"Subject: My state has just changed to: </span><span class="si">#{</span><span class="vi">@state</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">notify</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">StoreObserverA</span> <span class="o">&lt;</span> <span class="no">InterfaceObserver</span>
  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Inform A: </span><span class="si">#{</span><span class="n">subject</span><span class="p">.</span><span class="nf">state</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">StoreObserverB</span> <span class="o">&lt;</span> <span class="no">InterfaceObserver</span>
  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Inform B: </span><span class="si">#{</span><span class="n">subject</span><span class="p">.</span><span class="nf">state</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># the implementation</span>
<span class="n">store_observable</span> <span class="o">=</span> <span class="no">StoreObservable</span><span class="p">.</span><span class="nf">new</span>
<span class="n">store_observer_a</span> <span class="o">=</span> <span class="no">StoreObserverA</span><span class="p">.</span><span class="nf">new</span>
<span class="n">store_observer_b</span> <span class="o">=</span> <span class="no">StoreObserverB</span><span class="p">.</span><span class="nf">new</span>

<span class="c1"># let observer to observes the observable</span>
<span class="n">store_observable</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">store_observer_a</span><span class="p">)</span>
<span class="n">store_observable</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">store_observer_b</span><span class="p">)</span>

<span class="c1"># the states of the observers will change according to the state of store observable</span>
<span class="n">store_observable</span><span class="p">.</span><span class="nf">business_logic</span>
<span class="n">store_observable</span><span class="p">.</span><span class="nf">business_logic</span>

<span class="n">store_observable</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">store_observer_a</span><span class="p">)</span>

<span class="c1"># the observer a will not be notified</span>
<span class="n">store_observable</span><span class="p">.</span><span class="nf">business_logic</span>
</code></pre></div></div>

<p>What we can do more:</p>

<ul>
  <li>add methods to specify informing methods in <code class="language-plaintext highlighter-rouge">StoreObserver</code>; for example, use phone for <code class="language-plaintext highlighter-rouge">StoreObserverA</code> and use computer for <code class="language-plaintext highlighter-rouge">StoreObserverB</code></li>
  <li>add methods to specify when to inform <code class="language-plaintext highlighter-rouge">StoreObserver</code>; for example, only particular events or particular timing</li>
</ul>

<h2 id="reference">Reference</h2>

<p><a href="https://www.youtube.com/watch?v=_BpmfnqjgzQ&amp;list=PLrhzvIcii6GNjpARdnO4ueTUAVR9eMBpc&amp;index=2">Observer Pattern – Design Patterns (ep 2)</a></p>

<p><a href="https://refactoring.guru/design-patterns/observer/ruby/example">Observer in Ruby</a></p>

<p><a href="https://refactoring.guru/design-patterns/observer">Observer</a></p>
