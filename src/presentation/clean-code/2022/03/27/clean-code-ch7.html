<h2 id="introduction">Introduction</h2>

<p>The methodology forces coders to handle exception with Try-Catch-Finally Statement</p>

<h2 id="why">Why?</h2>

<p>We want code that handles errors with grace and style.</p>

<h2 id="how">How?</h2>

<ol>
  <li>Use Exception Rather Than Return Codes: we easily forget the <code class="language-plaintext highlighter-rouge">else</code> section</li>
  <li>Write your Try-Catch-Finally Statement First: use TDD to force exceptions</li>
  <li>Use Unchecked Exceptions: not an issue in ruby</li>
  <li>Provide Context with Exceptions: write as clear as possible</li>
  <li>Define Exception Classes in Terms of a Caller’s Needs: the concept of inteface</li>
  <li>Define the Normal Flow: remove the exception if it should be part of business logic</li>
  <li>Don’t Return Null</li>
  <li>Don’t Pass Null</li>
</ol>

<h2 id="what">What?</h2>

<h3 id="use-exception-rather-than-return-codes">Use Exception Rather Than Return Codes</h3>

<p>Given device has been initalized somewhere and we use DeviceHandle to handle this device,</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DeviceController</span>
  <span class="o">...</span>
  <span class="k">def</span> <span class="nf">send_shut_down</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="no">DeviceHandle</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">ENVIRONMENT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handle</span> <span class="o">==</span> <span class="no">DeviceHandle</span><span class="o">.</span><span class="no">VALID</span>
      <span class="n">record</span> <span class="o">=</span> <span class="n">retrieve_device_record</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">record</span><span class="p">.</span><span class="nf">getStatus</span> <span class="o">!=</span> <span class="no">DEVICE_SUSPENDED</span>
        <span class="n">pause_device</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">clear_device_work_queue</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">close_device</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">"Device suspended. Unable to shut down"</span><span class="p">);</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="n">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">"Invalid handle for: "</span> <span class="o">+</span> <span class="no">ENVIRONMENT</span><span class="p">);</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">...</span>
</code></pre></div></div>

<p>to</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DeviceController</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="k">def</span> <span class="nf">send_shut_down</span>
    <span class="k">begin</span>
      <span class="n">try_to_shut_down</span>
    <span class="k">rescue</span> <span class="no">DeviceShutDownError</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">try_to_shut_down</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="no">DeviceHandle</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">ENVIRONMENT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handle</span> <span class="o">==</span> <span class="no">DeviceHandle</span><span class="o">.</span><span class="no">VALID</span>
      <span class="n">record</span> <span class="o">=</span> <span class="n">retrieve_device_record</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">record</span><span class="p">.</span><span class="nf">getStatus</span> <span class="o">!=</span> <span class="no">DEVICE_SUSPENDED</span>
        <span class="n">pause_device</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">clear_device_work_queue</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">close_device</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<h3 id="write-your-try-catch-finally-statement-first">Write your Try-Catch-Finally Statement First</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'file'</span> <span class="k">do</span>
  <span class="o">...</span>
  <span class="n">context</span> <span class="s1">'after retriving an invalid file'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'should return exception'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">{</span><span class="no">File</span><span class="p">.</span><span class="nf">retrieve</span><span class="p">(</span><span class="s1">'invalid_file'</span><span class="p">)}.</span><span class="nf">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">NoFileError</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Then given the spec, we will write method as follow:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">File</span>
  <span class="o">...</span>
  <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">begin</span>
      <span class="s1">'some process'</span>
    <span class="k">rescue</span> <span class="no">NoFileError</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="nb">puts</span> <span class="s1">'cannot find the file'</span> <span class="o">+</span> <span class="n">e</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This approach makes sure exception to be included in the methods.</p>

<h3 id="use-unchecked-exceptions">Use Unchecked Exceptions</h3>

<p>There is <strong>no</strong> checked exceptions in <strong>ruby</strong> but in <strong>java</strong>. Java will <strong>check</strong> obvious errors while compiling; to avoid it in java, use Try-Catch-Finally statements. Since the author forces us to use this statements at all time, we do not need checked exceptions.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CheckedVsUnchecked</span> <span class="o">{</span>
  
  <span class="kd">public</span> <span class="n">satic</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
    
    <span class="n">readFile</span><span class="o">(</span><span class="err">'</span><span class="n">myFile</span><span class="o">.</span><span class="na">txt</span><span class="err">'</span><span class="o">);</span> <span class="c1">// no myFile.txt</span>
    
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">readFile</span> <span class="o">(</span><span class="nc">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span> <span class="c1">// must use it or it will not compile</span>
      <span class="nc">FileReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="n">fileName</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">FileNotFoundException</span> <span class="n">fnfe</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="err">'</span><span class="nc">No</span> <span class="n">file</span> <span class="n">found</span><span class="err">'</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="provide-context-with-exceptions">Provide Context with Exceptions</h3>

<p>use</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">File</span>
  <span class="o">...</span>
  <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">begin</span>
      <span class="s1">'some process'</span>
    <span class="k">rescue</span> <span class="no">NoFileError</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="nb">puts</span> <span class="s1">'cannot find the file'</span> <span class="o">+</span> <span class="n">e</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>instead of</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">File</span>
  <span class="o">...</span>
  <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">begin</span>
      <span class="s1">'some process'</span>
    <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">e</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="define-exception-classes-in-terms-of-a-callers-needs">Define Exception Classes in Terms of a Caller’s Needs</h3>

<p>For example, ACMEPort may throw three kinds of exceptions <code class="language-plaintext highlighter-rouge">DeviceResponseException</code>, <code class="language-plaintext highlighter-rouge">ATM1212UnlockedException</code>, and <code class="language-plaintext highlighter-rouge">GMXError</code>. We should use the concept of API</p>

<p>From</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">port</span> <span class="o">=</span> <span class="no">ACMEPort</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>

<span class="k">def</span> <span class="nf">perform</span>
  <span class="k">begin</span>
    <span class="n">port</span><span class="p">.</span><span class="nf">open</span><span class="p">()</span>
  <span class="k">rescue</span> <span class="no">DeviceResponseException</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="n">reportPortError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">"Device response exception"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">ATM1212UnlockedException</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="n">reportPortError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">"Unlock exception"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">GMXError</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="n">reportPortError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">"Device response exception"</span><span class="p">)</span>
  <span class="k">ensure</span>
    <span class="o">...</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>to</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">port</span> <span class="o">=</span> <span class="no">LocalPort</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">perform</span>
  <span class="k">begin</span>
    <span class="n">port</span><span class="p">.</span><span class="nf">open</span>
  <span class="k">rescue</span> <span class="no">PortDeviceFailure</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="n">reportError</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="nf">getMessage</span><span class="p">(),</span> <span class="n">e</span><span class="p">);</span>
  <span class="k">ensure</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">LocalPort</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">portNumber</span><span class="p">)</span>
    <span class="n">innerPort</span> <span class="o">=</span> <span class="no">ACMEPort</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">portNumber</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">open</span>
    <span class="k">begin</span>
      <span class="n">innerPort</span><span class="p">.</span><span class="nf">open</span>
    <span class="k">rescue</span> <span class="no">DeviceResponseException</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="k">raise</span> <span class="no">PortDeviceFailure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">rescue</span> <span class="no">ATM1212UnlockedException</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="k">raise</span> <span class="no">PortDeviceFailure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">rescue</span> <span class="no">GMXError</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="k">raise</span> <span class="no">PortDeviceFailure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="define-the-normal-flow">Define the Normal Flow</h3>

<p>Avoid putting business logic into rescue section</p>

<p>From</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">perform</span>
  <span class="k">begin</span>
    <span class="n">meal_expenses</span> <span class="o">=</span> <span class="no">ExpenseReportDAO</span><span class="p">.</span><span class="nf">meals</span><span class="p">(</span><span class="n">employee</span><span class="o">.</span><span class="no">ID</span><span class="p">)</span>
    <span class="n">m_total</span> <span class="o">+=</span> <span class="n">meal_expenses</span>
  <span class="k">rescue</span>
    <span class="n">m_total</span> <span class="o">+=</span> <span class="n">meal_per_diem</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>to</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">perform</span>
  <span class="n">meal_expenses</span> <span class="o">=</span> <span class="no">ExpenseReportDAO</span><span class="p">.</span><span class="nf">meals</span><span class="p">(</span><span class="n">employee</span><span class="o">.</span><span class="no">ID</span><span class="p">)</span>
  <span class="n">m_total</span> <span class="o">+=</span> <span class="n">meal_expenses</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ExpenseReportDAO</span>
  <span class="k">def</span> <span class="nf">meals</span>
    <span class="k">if</span> <span class="n">meal_expense</span>
      <span class="k">return</span> <span class="n">meal_expense</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="n">per_diem_amount</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="dont-return-null">Don’t Return Null</h3>

<p>Return empty object or raise an error instead</p>

<p>From</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">employees</span> <span class="o">=</span> <span class="n">get_employees</span>

<span class="k">if</span> <span class="n">employees</span> <span class="o">!=</span> <span class="kp">nil</span>
  <span class="n">employees</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">employee</span><span class="o">|</span>
    <span class="n">total_pay</span> <span class="o">+=</span> <span class="n">employee</span><span class="p">.</span><span class="nf">pay</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">get_employees</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>to</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">employees</span> <span class="o">=</span> <span class="n">get_employees</span>

<span class="n">employees</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">employee</span><span class="o">|</span>
  <span class="n">total_pay</span> <span class="o">+=</span> <span class="n">employee</span><span class="p">.</span><span class="nf">pay</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">get_employees</span>
  <span class="o">...</span>
  <span class="k">return</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">no_employees</span>
  <span class="c1"># or</span>
  <span class="k">raise</span> <span class="no">NoEmployeeError</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="dont-pass-null">Don’t Pass Null</h3>

<p>Pass <code class="language-plaintext highlighter-rouge">null</code> usually do not have meaningful results. We should raise exception in the method; however it still cost some run time. The better way is just return it if caller pass a null value.</p>

<h2 id="reference">Reference</h2>

<p>clean code by Robert</p>
