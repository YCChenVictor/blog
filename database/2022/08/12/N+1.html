<!DOCTYPE html>
<html lang="en-US">
  <head>
    <!-- 3D drawing -->
    
    <!-- 2D drawing -->
    
    <!-- for mathjax support -->
    
    <!-- mermaid --><meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" href="/blog/assets/css/main.css">
    <script src="https://kit.fontawesome.com/f9271f6bdd.js" crossorigin="anonymous"></script>
    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark-dimmed.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
  </head>

  <body class="font-mono list-disc">
    <div class="pt-12 pb-4">
      
        <nav class="flex flex-wrap items-center justify-center px-2 mb-6">
  <div class="container px-4 mx-auto flex flex-wrap items-center justify-center">
    <div class="w-full relative flex justify-center">
      <button type="button" onclick="toggleNavbar('navbar')"
        class="rounded-md inline-flex items-center justify-center text-gray-500 md:hidden"
        aria-expanded="false">
        <span class="sr-only">Open menu</span>
        <!-- Heroicon name: outline/menu -->
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
          stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>

    <div class="flex hidden md:block" id="navbar">
      <div class="flex flex-col md:flex-row mr-auto w-full">
         <!-- don't show Home in menu for Homepage -->
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/blog/">
          Home
        </a>
        

      <!-- dynamic menu based on navigation info in _config.yml -->
      
         <!-- don't show current page in menu -->
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/blog/about">
          About
        </a>
        
      
         <!-- don't show current page in menu -->
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/blog/category">
          Category
        </a>
        
      
    </div>
    </div>
  </div>
</nav>
        <div id="sidebar" class="p-4 fixed"></div>
      
      <div class="px-4 pt-4 prose prose-indigo">
  <h1 class="text-center mt-6 mb-6">N+1</h1>
  <div class="text-center">
    
  </div>
  <div class="px-72">
    <h2 id="introduction">Introduction</h2>

<p>N+1 query problem happens when there are N queries depends on 1 query; for example, given model relation that user has many blog posts. Given we are in the loop of posts. if we want to retrieve all the author name, intuitively, we may compose ORM command as follow:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Post</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">post</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">name</span> <span class="k">end</span>
</code></pre></div></div>

<p>and the SQL command looks like as follow:</p>

<pre><code class="language-SQL">SELECT "posts".* FROM "posts"
SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 2], ["LIMIT", 1]]
SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 2], ["LIMIT", 1]]
SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 33], ["LIMIT", 1]]
SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 4], ["LIMIT", 1]]
SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 4], ["LIMIT", 1]]
...
</code></pre>

<p>We can notice that there are two posts from user 2, one post from user 33, and two posts from user 4, …etc, which cause by that we ask computer to look for user one by one according to posts, so the solution should tell computer to just query <code class="language-plaintext highlighter-rouge">posts</code> and <code class="language-plaintext highlighter-rouge">users</code> once and compose and show the results we want afterwards, going to reduce the SQL commands as folow:</p>

<pre><code class="language-SQL">SELECT "posts".* FROM "posts"
SELECT "users".* FROM "users" WHERE "users"."id" IN (?, ?, ?, ?, ?)  [["id", 2], ["id", 4], ["id", 33]]
</code></pre>

<h2 id="why">Why?</h2>

<p>We want server side to prepare data as quick as possible.</p>

<h2 id="how">How?</h2>

<p>try to answer how include works</p>

<h2 id="what">What?</h2>

<p>In rails, we solve it with includes and join</p>

<ul>
  <li>N + 1</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="k">do</span>
  <span class="no">ActivityStudent</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">activity</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">activity</span><span class="p">.</span><span class="nf">student</span><span class="p">.</span><span class="nf">name</span> <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<ul>
  <li>includes</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="k">do</span>
  <span class="no">ActivityStudent</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:student</span><span class="p">).</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">activity</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">activity</span><span class="p">.</span><span class="nf">student</span><span class="p">.</span><span class="nf">name</span> <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<ul>
  <li>joins</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="k">do</span>
  <span class="no">ActivityStudent</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:student</span><span class="p">).</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">activity</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">activity</span><span class="p">.</span><span class="nf">student</span><span class="p">.</span><span class="nf">name</span> <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="reference">Reference</h2>

<p><a href="https://medium.com/doctolib/understanding-and-fixing-n-1-query-30623109fe89">Understanding and fixing N+1 query</a></p>

  </div>
</div>

<footer class="relative px-4 pt-4 pb-4">
  
  <!-- divider -->
  <div class="relative my-8">
    <div class="absolute inset-0 flex items-center" aria-hidden="true">
      <div class="w-full border-t border-gray-200"></div>
    </div>
    <div class="relative flex justify-center ">
      <span class="bg-white px-2 text-gray-200">
        <i class="text-xs far fa-square"></i>
      </span>
    </div>
  </div>

  <!-- footer msg -->
  <div class="flex flex-wrap items-center justify-center">
    <div class="text-sm text-gray-300">
      © <span id="get-current-year"></span>
      
      <a href="" class="!no-underline">
        
      </a>
      
    </div>
  </div>
  </div>
</footer>

<script type="text/javascript" src="/blog/assets/javascripts/bundle.js" charset="utf-8"></script>

    </div>
  </body>

  <script>
    /* Funtion for getting the current year in the footer */
    (function () {
      if (document.getElementById("get-current-year")) {
        document.getElementById(
          "get-current-year"
        ).innerHTML = new Date().getFullYear();
      }
    })();

    /* Function for opning navbar on mobile */
    function toggleNavbar(collapseID) {
        document.getElementById(collapseID).classList.toggle("hidden");
        document.getElementById(collapseID).classList.toggle("block");
      }
      /* Function for dropdowns */
      function openDropdown(event, dropdownID) {
        let element = event.target;
        while (element.nodeName !== "A") {
          element = element.parentNode;
        }
        document.getElementById(dropdownID).classList.toggle("hidden");
        document.getElementById(dropdownID).classList.toggle("block");
      }
  </script>
</html>
