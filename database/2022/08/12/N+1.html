<!DOCTYPE html>
<html lang="en-US">
  <head>
    

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <link rel="stylesheet" href="/blog/assets/css/main.css">
    <script src="https://kit.fontawesome.com/f9271f6bdd.js" crossorigin="anonymous"></script>
    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark-dimmed.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
  </head>

  <body class="font-mono list-disc bg-gray-700">
    <div class="pt-8 bg-gray-700">
      
        <nav class="flex flex-wrap items-center justify-center px-2 py-4 mb-6">
  <div class="titleImagePosition">
    <a href="/blog/" class="!px-0 !py-0">
      <img class="titleImage" src="/blog/assets/img/title.jpeg" alt="author profile image">
    </a>
  </div>
</nav>

      
      
  
    <div id='sidebar' class='fixed py-16 hidden lg:block'></div>
    <div id='burger-sidebar' class='pt-24 pl-4 fixed hidden md:block'></div>
  

  <div class='prose bg-gray-400' id='article'>
    <div id='word-count' class='pt-4 pl-8 fixed'>words: 80</div>
    <div class='text-center'>
      
    </div>
    <div class='md:px-4 md:grid lg:px-72'>
      <h1 class='text-center mt-6 mb-6'>N+1</h1>
      <h2 id="introduction">Introduction</h2>

<p>N+1 query problem happens when there are N queries depends on 1 query; for example, given model relation that user has many blog posts. Given we are in the loop of posts. if we want to retrieve all the author name, intuitively, we may compose ORM command as follow:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Post</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">post</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">name</span> <span class="k">end</span>
</code></pre></div></div>

<p>and the SQL command looks like as follow:</p>

<pre><code class="language-SQL">SELECT "posts".* FROM "posts"
SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 2], ["LIMIT", 1]]
SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 2], ["LIMIT", 1]]
SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 33], ["LIMIT", 1]]
SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 4], ["LIMIT", 1]]
SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 4], ["LIMIT", 1]]
...
</code></pre>

<p>We can notice that there are two posts from user 2, one post from user 33, and two posts from user 4, â€¦etc, which cause by that we ask computer to look for user one by one according to posts, so the solution should tell computer to just query <code class="language-plaintext highlighter-rouge">posts</code> and <code class="language-plaintext highlighter-rouge">users</code> once and compose and show the results we want afterwards, going to reduce the SQL commands as folow:</p>

<pre><code class="language-SQL">SELECT "posts".* FROM "posts"
SELECT "users".* FROM "users" WHERE "users"."id" IN (?, ?, ?, ?, ?)  [["id", 2], ["id", 4], ["id", 33]]
</code></pre>

<h2 id="why">Why?</h2>

<p>We want server side to prepare data as quick as possible.</p>

<h2 id="how">How?</h2>

<p>try to answer how include works</p>

<h2 id="what">What?</h2>

<p>In rails, we solve it with includes and join</p>

<ul>
  <li>N + 1</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="k">do</span>
  <span class="no">ActivityStudent</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">activity</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">activity</span><span class="p">.</span><span class="nf">student</span><span class="p">.</span><span class="nf">name</span> <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<ul>
  <li>includes</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="k">do</span>
  <span class="no">ActivityStudent</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:student</span><span class="p">).</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">activity</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">activity</span><span class="p">.</span><span class="nf">student</span><span class="p">.</span><span class="nf">name</span> <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<ul>
  <li>joins</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="k">do</span>
  <span class="no">ActivityStudent</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:student</span><span class="p">).</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">activity</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">activity</span><span class="p">.</span><span class="nf">student</span><span class="p">.</span><span class="nf">name</span> <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="reference">Reference</h2>

<p><a href="https://medium.com/doctolib/understanding-and-fixing-n-1-query-30623109fe89">Understanding and fixing N+1 query</a></p>

    </div>
  </div>

  <footer class="relative px-4 pt-4 pb-4">
    <!-- footer msg -->
  <div class="flex flex-wrap items-center justify-center">
    <br>
  </div>
</footer>


      <button
        type="button"
        data-mdb-ripple="true"
        data-mdb-ripple-color="light"
        class="scrollTopBtn"
        id="btn-back-to-top"
      >
        <svg aria-hidden="true" focusable="false" data-prefix="fas" class="w-4 h-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"></path></svg>
      </button>
    </div>
  </body>

  <script>
    /* Function for getting the current year in the footer */
    (function () {
      if (document.getElementById("get-current-year")) {
        document.getElementById(
          "get-current-year"
        ).innerHTML = new Date().getFullYear();
      }
    })();
    /* Function for opening navbar on mobile */
    function toggleNavbar(collapseID) {
        document.getElementById(collapseID).classList.toggle("hidden");
        document.getElementById(collapseID).classList.toggle("block");
      }
    /* Function for dropdowns */
    function openDropdown(event, dropdownID) {
      let element = event.target;
      while (element.nodeName !== "A") {
        element = element.parentNode;
      }
      document.getElementById(dropdownID).classList.toggle("hidden");
      document.getElementById(dropdownID).classList.toggle("block");
    }

    // Get the button
    let myButton = document.getElementById("btn-back-to-top");
    // When the user scrolls down 20px from the top of the document, show the button
    window.onscroll = function () {
      scrollFunction();
    };
    function scrollFunction() {
      if (
        document.body.scrollTop > 20 ||
        document.documentElement.scrollTop > 20
      ) {
        myButton.style.display = "block";
      } else {
        myButton.style.display = "none";
      }
    }
    // When the user clicks on the button, scroll to the top of the document
    myButton.addEventListener("click", backToTop);
    function backToTop() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }
  </script>

  <script type="text/javascript" src="/blog/assets/javascript/bundle.js" charset="utf-8"></script>
</html>
