<!DOCTYPE html>
<html lang="en-US">
  <head>
    

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <link rel="stylesheet" href="/blog/assets/css/main.css">
    <script src="https://kit.fontawesome.com/f9271f6bdd.js" crossorigin="anonymous"></script>
    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark-dimmed.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
  </head>

  <body class="font-mono list-disc bg-gray-700">
    <div class="pt-8 bg-gray-700">
      
        <nav class="flex flex-wrap items-center justify-center px-2 py-4 mb-6">
  <div class="titleImagePosition">
    <a href="/blog/" class="!px-0 !py-0">
      <img class="titleImage" src="/blog/assets/img/title.jpeg" alt="author profile image">
    </a>
  </div>
</nav>

      
      
  
    <div id='sidebar' class='fixed py-16 hidden lg:block'></div>
    <div id='burger-sidebar' class='pt-24 pl-4 fixed hidden md:block'></div>
  

  <div class='prose bg-gray-400' id='article'>
    <div id='word-count' class='pt-4 pl-8 fixed'>words: 80</div>
    <div class='text-center'>
      
    </div>
    <div class='md:px-4 md:grid lg:px-72'>
      <h1 class='text-center mt-6 mb-6'>Signup Login</h1>
      <h2 id="introduction">Introduction</h2>

<p>This article provides a step-by-step guide on implementing sign up and log in functionality in your Node.js application using express-session for session management and passport for login authentication. It covers the usage of middleware for authentication, supports multiple authentication strategies including Local Authentication, OAuth (e.g., Facebook, Google), and OpenID Connect, and demonstrates how to enhance security by utilizing bcrypt to encode and store passwords securely in the database, ensuring protection against potential attackers.</p>

<h2 id="why">Why?</h2>

<p>Validate whether this user can use our product</p>

<h2 id="how">How?</h2>

<h3 id="database">Database</h3>

<p>Refer to [database]</p>

<h3 id="server">Server</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="c1">// session: used to manage and maintain session data, providing a way to store and retrieve user-specific information across multiple requests.</span>
<span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express-session</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span>
  <span class="na">secret</span><span class="p">:</span> <span class="dl">'</span><span class="s1">any secret</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">resave</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">saveUninitialized</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">}));</span>

<span class="c1">// passport: used in Node.js applications with the 'passport' middleware to handle user authentication using username and password credentials stored locally.</span>
<span class="kd">const</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./middleware/passport.js</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>
<span class="p">...</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">app</span>
</code></pre></div></div>

<h3 id="user-model">User Model</h3>

<p>Given we setup the <a href="2022-01-20-model">model</a> environment, create a file <code class="language-plaintext highlighter-rouge">models/user.js</code> with</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">Sequelize</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">sequelize</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">sequelize</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./index.js</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="dl">'</span><span class="s1">user</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">email</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="na">password</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">STRING</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">user</span>
</code></pre></div></div>

<h3 id="passport-middleware">Passport Middleware</h3>

<p>You can think <code class="language-plaintext highlighter-rouge">passport.js</code> as a middleware to check whether this user can enter the border of our app.</p>

<ul>
  <li>add <code class="language-plaintext highlighter-rouge">./middleware/passport.js</code></li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../database/models/user.js</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">LocalStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">passport-local</span><span class="dl">'</span><span class="p">).</span><span class="nx">Strategy</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">passport</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">jsonwebtoken</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">customizedPassport</span> <span class="o">=</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span>
  <span class="k">new</span> <span class="nx">LocalStrategy</span><span class="p">({</span> <span class="c1">// here can be changed to JWT strategy</span>
    <span class="na">usernameField</span><span class="p">:</span> <span class="dl">'</span><span class="s1">email</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">passwordField</span><span class="p">:</span> <span class="dl">'</span><span class="s1">password</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">session</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">},</span> <span class="k">async</span> <span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
      <span class="nx">username</span><span class="p">,</span>
      <span class="nx">password</span>
    <span class="p">})</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">no user</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="dl">'</span><span class="s1">secret_key</span><span class="dl">'</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="na">token</span><span class="p">:</span> <span class="nx">token</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">);</span>

<span class="nx">customizedPassport</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">customizedPassport</span><span class="p">.</span><span class="nx">deserializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">customizedPassport</span>
</code></pre></div></div>

<h3 id="api">API</h3>

<ul>
  <li>user story
    <ul>
      <li>signup
        <ul>
          <li>frontend post email and password</li>
          <li>backend encode password with bcrypt and store email and encoded password in database</li>
          <li>return jwt token</li>
        </ul>
      </li>
      <li>login
        <ul>
          <li>frontend post email and password</li>
          <li>backend find user with email</li>
          <li>backend decode password</li>
          <li>return jwt token</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>code example
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">passport</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../middleware/passport.js</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">User</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../database/models/user.js</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">jwt</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonwebtoken</span><span class="dl">'</span>
  
<span class="kd">const</span> <span class="nx">userAPIs</span> <span class="o">=</span> <span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/signup</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span> <span class="c1">// Destructure email and password from req.body.params</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span> <span class="o">||</span> <span class="o">!</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Please enter all fields</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span>
  
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="nx">email</span><span class="p">,</span>
        <span class="nx">password</span>
      <span class="p">});</span>
  
      <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="p">},</span> <span class="dl">'</span><span class="s1">secret_key</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Wrap the payload in an object</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">token</span> <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Handle error during user creation</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">'</span><span class="s1">An error occurred</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">local</span><span class="dl">'</span><span class="p">),</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">token</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">token</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span>
  
<span class="k">export</span> <span class="k">default</span> <span class="nx">userAPIs</span>
</code></pre></div>    </div>
  </li>
  <li>QA
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-d</span> <span class="s1">'{"key": "item"}'</span> <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="nt">-X</span> POST https://any_existed_url.com/
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="spec">spec</h3>

<p>TBC</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<h3 id="session-vs-token">session vs token</h3>

<p>I just choose JWT (token) for my apps (Of course, we can use both). Both sessions and JWTs (JSON Web Tokens) are commonly used for user authentication and authorization.</p>

<p>Session: server-side authentication -&gt; server creates unique session ID -&gt; store on server -&gt; send it to client as cookie -&gt; client send session ID in each request -&gt; match for authentication</p>

<p>JWT: stateless authentication -&gt; server generates token containing the user’s identity -&gt; send to client as a response to a successful login request -&gt; client includes the token in header of requests -&gt; server authenticate and authorize</p>

<h2 id="what">What?</h2>

<p>give a project and use postman to demo</p>

<h2 id="reference">Reference</h2>

<p><a href="https://dev.to/ganeshmani/node-authentication-using-passport-js-part-1-53k7">Node Authentication using passport.js - Part 1</a></p>

<p><a href="https://stackoverflow.com/questions/33247602/how-do-you-debug-jest-tests">How do you debug Jest Tests?</a></p>

<p><a href="https://www.passportjs.org/concepts/authentication/password/">Username &amp; Password</a></p>

<p><a href="https://dmitryrogozhny.com/blog/easy-way-to-debug-passport-authentication-in-express">Easy Way to Debug Passport Authentication in Express</a></p>

<p><a href="https://pjchender.dev/npm/npm-passport/">[npm] Passport 筆記（Learn to Use Passport JS）</a></p>

<p><a href="https://www.youtube.com/watch?v=UBUNrFtufWo">Session vs Token Authentication in 100 Seconds</a></p>

    </div>
  </div>

  <footer class="relative px-4 pt-4 pb-4">
    <!-- footer msg -->
  <div class="flex flex-wrap items-center justify-center">
    <br>
  </div>
</footer>


      <button
        type="button"
        data-mdb-ripple="true"
        data-mdb-ripple-color="light"
        class="scrollTopBtn"
        id="btn-back-to-top"
      >
        <svg aria-hidden="true" focusable="false" data-prefix="fas" class="w-4 h-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"></path></svg>
      </button>
    </div>
  </body>

  <script>
    /* Function for getting the current year in the footer */
    (function () {
      if (document.getElementById("get-current-year")) {
        document.getElementById(
          "get-current-year"
        ).innerHTML = new Date().getFullYear();
      }
    })();
    /* Function for opening navbar on mobile */
    function toggleNavbar(collapseID) {
        document.getElementById(collapseID).classList.toggle("hidden");
        document.getElementById(collapseID).classList.toggle("block");
      }
    /* Function for dropdowns */
    function openDropdown(event, dropdownID) {
      let element = event.target;
      while (element.nodeName !== "A") {
        element = element.parentNode;
      }
      document.getElementById(dropdownID).classList.toggle("hidden");
      document.getElementById(dropdownID).classList.toggle("block");
    }

    // Get the button
    let myButton = document.getElementById("btn-back-to-top");
    // When the user scrolls down 20px from the top of the document, show the button
    window.onscroll = function () {
      scrollFunction();
    };
    function scrollFunction() {
      if (
        document.body.scrollTop > 20 ||
        document.documentElement.scrollTop > 20
      ) {
        myButton.style.display = "block";
      } else {
        myButton.style.display = "none";
      }
    }
    // When the user clicks on the button, scroll to the top of the document
    myButton.addEventListener("click", backToTop);
    function backToTop() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }
  </script>

  <script type="text/javascript" src="/blog/assets/javascript/bundle.js" charset="utf-8"></script>
</html>
