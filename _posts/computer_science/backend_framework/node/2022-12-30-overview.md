---
layout: post
title:
description: ''
date: '2022-12-30'
categories: node
note: 把文章 extract 出來
mathjax:
mermaid:
p5:
threeJS:
anchor:
publish: true
---

## Introduction

This article describes how to setup baseline node app.

## Why?

* node: real-time, high-performance, and scalable network applications.
* rails: convention -> easier to code & build app quicker

## How?

### init

(1) install dependencies:

* for production
  * node
  * pg
  * dotenv
  * axios
* for development
  * nodemon
  * debug

(2) initialize:

```bash
mkdir my-project
cd my-project
npm init -y
```

(3) git:

add `.gitignore`

```bash
# Dependency directories
node_modules/

# Optional npm cache directory
.npm

# dotenv environment variables file
.env
```

(4) env:

```bash
npm install dotenv --save
```

create `.env` on root with

```linux
DB_NAME=task
DB_USERNAME=username_you_want
DB_PASSWORD=password_you_want
```

require it with

```javascript
require('dotenv').config()
console.log(`Database name is ${process.env.DB_NAME}`);
console.log(`Database username is ${process.env.DB_USERNAME}`);
console.log(`Database password is ${process.env.DB_PASSWORD}`);
```

(5) server

```bash
npx nodemon server.js
```

### structure

```bash
.
├── __test__
├── api
├── app.js
├── database
├── node_modules
├── package-lock.json
└── package.json
```

#### import and export

[import & export]({{site.baseurl}}/blog/javascript/2022/12/12/overview.html#import-and-export)

#### absolute path (TBC)

install required package with `npm install --save-dev babel-plugin-module-resolver` ([babel-plugin-module-resolver](https://www.npmjs.com/package/babel-plugin-module-resolver))

and in `./.babel.config.js`, add

```bash
module.exports = {
  presets: ['module:metro-react-native-babel-preset'],
  plugins: [
    [
      'module-resolver',
      {
        root: ['./src'],
        extensions: ['.ios.js', '.android.js', '.js', '.ts', '.tsx', '.json'],
        alias: {
          '*': '.',
          '@root': './',
          '@src': './src',
          '@components': './src/components',
        }
      }
    ]
  ]
};
```

then we can import with

```javascript
import Button from 'src/components/Button';
```

### server

create `app.js` with

```js
const express = require('express')
const app = express()

app.get('/', (req, res) => {
  res.send('Hello World!')
})

app.listen(5000, () => {
  console.log('Server listening on port 5000')
})
```

and run it with `node server.js`

* test it with curl: `curl http://localhost:5000/`

### database

[database setup]({{site.baseurl}}/node/2022/12/30/database.html)

### model

create `./model/index.js` with

```javascript
'use strict';

require('dotenv').config()

const Sequelize = require('sequelize');

let sequelize
if (process.env.NODE_ENV === 'development') {
  sequelize = new Sequelize(process.env.DEV_DATABASE_URL)
} else if (process.env.NODE_ENV === 'test') {
  sequelize = new Sequelize(process.env.TEST_DATABASE_URL)
} else {
  sequelize = new Sequelize(process.env.DATABASE_URL)
}

module.exports = sequelize;
```

and then in `./model/user.js`

```javascript
'use strict';
const Sequelize = require('sequelize');
const sequelize = require('./index.js');

const user = sequelize.define('user', {
  name: {
    type: Sequelize.STRING
  },
  mail: {
    type: Sequelize.STRING
  },
  password: {
    type: Sequelize.STRING
  }
})

module.exports = user
```

#### CRUD

After the database setup, with `sequelize`, we can

```javascript
// Create
build

// Read
findAll

// Update

// Delete
```

### API

create a directory, `api/` with API going to be imported in `app.js`

For example, `api/summary.js`

```javascript
module.exports = function(app) {
  app.get('/', (req, res) => {
    res.send('Hello World!')
  })
  app.post('/sign_up', (req, res) => {
    res.send('Hello World!')
  })
}
```

in `app.js`,

```javascript
...
const express = require('express')
const api = require('./routes_summary.js');
const app = express()

app.use(express.json())
app.listen(5000, () => {
  api(app)
  ...
})
...
```

#### restful API

Given [pre-knowledge]({{site.baseurl}}/api/2021/02/18/overview.html), we can compose them as follow:

```javascript
// restful API
// GET /records -> records#index
// POST /records -> records#create
// GET /records/new -> records#new
// GET /records/:id/edit -> records#edit
// GET /records/:id -> records#show
// PATCH /records/:id -> records#update
// PUT /records/:id -> records#update
// DELETE /records/:id -> records#destroy

const modelUser = require('../database/models/user.js')

module.exports = (app) => {
  // create
  app.post('/sign_up', (req, res) => {
    modelUser.signUp(req.body)
    console.log(res)
  });
  // read, index
  app.get('/users', () => {
    console.log('============')
    console.log(modelUser)
    return modelUser.findAll({
      order: [
          ['id', 'ASC'],
      ],
    })
  })
}
```

### sign up and login mechanism

[sign up and login]({{site.baseurl}}/node/2022/12/31/sign-up-and-login.html)

### spec

#### environment

add `spec_config`

```javascript
jest.mock('pg', () => { // should extract to other file
  const mPool = {
    connect: function () {
      return { query: jest.fn() };
    },
    query: jest.fn(),
    end: jest.fn(),
    on: jest.fn(),
  };
  return { Pool: jest.fn(() => mPool) };
});
```

in `.env` add

```bash
TEST_DATABASE_URL=postgres://spare:test1234@127.0.0.1:5432/task_test
```

use `request(app)` (export app from server.js and import request)

```javascript
describe('User', () => {
  ...

  describe('POST /signup', () => {
    describe('when valid email and password', () => {
      test('should return user id', () => {
        ...
        request(app).post('/sign_up', attributes).then(response => {
          ...
        });
      })
    })
  ...
});
```

#### compose

Please follow [jest AAA]({{site.baseurl}}/test/2021/04/06/TDD.html#aaa-principle-maps-jest) to write test

jest with node:

* wrap node related files in `./app`
* set jest root directory
* import related files in jest with relative path
* add script

```JSON
"scripts": {
  "test": "jest",
},
```

### debugger

In `package.json`,

```JSON
"scripts": {
  "debug": "nodemon --inspect-brk server.js"
}
```

and run debug with

```bash
npm run debug
```

and in chrome, enter `chrome://inspect` and then click "inspect"

## What?

place the task github url

and test it with

postman

## Reference

[How to organize routes in Nodejs Express app](https://stackoverflow.com/questions/59681974/how-to-organize-routes-in-nodejs-express-app)

[How to use .env file in node.js](https://dev.to/dallington256/how-to-use-env-file-in-nodejs-578h)

[Model Querying - Finders](https://sequelize.org/docs/v6/core-concepts/model-querying-finders/)

[jest debug](https://jestjs.io/docs/troubleshooting)

[Mocking a Database in Node with Jest](https://www.youtube.com/watch?v=IDjF6-s1hGk)
